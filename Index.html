<!DOCTYPE html>
<html lang="en-GB">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>RSA Driver App</title>
  <!-- PWA / installable app support -->
  <meta name="theme-color" content="#0D47A1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="RSA Driver">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="<?!= iconDataUri ?>">
  <link id="pwa-manifest" rel="manifest">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script>
    // Register datalabels plugin globally so all charts show values on bars
    if (typeof ChartDataLabels !== 'undefined') {
      Chart.register(ChartDataLabels);
    }
  </script>

  <style>
    /* ===== RESET & BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background: #F0F4F8;
      color: #212121;
      font-size: 17px;
      -webkit-font-smoothing: antialiased;
    }
    .hidden { display: none !important; }

    /* ===== CSS VARIABLES ===== */
    :root {
      --primary:       #1565C0;
      --primary-light: #1976D2;
      --primary-dark:  #0D47A1;
      --primary-pale:  #E3F2FD;
      --success:       #2E7D32;
      --success-light: #E8F5E9;
      --error:         #C62828;
      --error-light:   #FFEBEE;
      --warning:       #E65100;
      --warning-light: #FFF3E0;
      --card:          #FFFFFF;
      --border:        #E0E0E0;
      --text-secondary:#505050;
      --shadow:        0 2px 10px rgba(0,0,0,0.08);
      --shadow-md:     0 4px 20px rgba(0,0,0,0.12);
      --radius:        12px;
      --radius-sm:     8px;
    }

    /* ===== LAYOUT ===== */
    .screen { min-height: 100vh; padding-bottom: 24px; }
    .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    /* ===== APP HEADER ===== */
    .app-header {
      background: var(--primary-dark);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow-md);
    }
    .app-header h1 { font-size: 18px; font-weight: 500; flex: 1; }
    .app-header .material-icons { font-size: 24px; }
    .btn-icon {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      border-radius: 50%;
      min-height: 0;
    }
    .btn-icon:active { background: rgba(255,255,255,0.15); }

    /* ===== LANGUAGE TOGGLE ===== */
    .lang-toggle {
      display: flex;
      border: 1.5px solid rgba(255,255,255,0.4);
      border-radius: 20px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .lang-btn {
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.7);
      font-family: 'Roboto', sans-serif;
      font-size: 12px;
      font-weight: 600;
      padding: 5px 9px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      min-height: 32px;
      letter-spacing: 0.3px;
    }
    .lang-btn.active {
      background: rgba(255,255,255,0.25);
      color: white;
    }

    /* ===== DRIVER SELECTED CHIP ===== */
    .driver-chip {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--primary-pale);
      border: 1.5px solid var(--primary);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      margin-top: 8px;
    }
    .driver-chip .chip-icon { color: var(--primary); flex-shrink: 0; }
    .driver-chip .chip-info { flex: 1; }
    .driver-chip .chip-name { font-size: 16px; font-weight: 600; color: #212121; }
    .driver-chip .chip-id   { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .driver-chip .chip-clear {
      background: none; border: none; cursor: pointer;
      color: var(--text-secondary); padding: 4px;
      border-radius: 50%; display: flex; align-items: center;
      min-height: 0;
    }
    .driver-chip .chip-clear:active { background: rgba(0,0,0,0.08); }

    /* ===== RTL SUPPORT (Arabic) ===== */
    [dir="rtl"] .app-header,
    [dir="rtl"] .screen-header { flex-direction: row-reverse; }
    [dir="rtl"] .home-card { flex-direction: row-reverse; border-left: none; border-right: 4px solid var(--primary); }
    [dir="rtl"] .home-card.end { border-right-color: var(--success); border-left: none; }
    [dir="rtl"] .home-card[style*="F57F17"] { border-right-color: #F57F17; border-left: none; }
    [dir="rtl"] .driver-chip { flex-direction: row-reverse; }
    [dir="rtl"] .field-group label { text-align: right; direction: rtl; }
    [dir="rtl"] .info-box,
    [dir="rtl"] .success-box { flex-direction: row-reverse; border-left: none; border-right: 3px solid var(--primary); }
    [dir="rtl"] .success-box { border-right-color: var(--success); }
    [dir="rtl"] .mode-toggle-btn { border-right: none; border-left: 1.5px solid var(--border); }
    [dir="rtl"] .mode-toggle-btn:last-child { border-left: none; }
    [dir="rtl"] .confirm-row { flex-direction: row-reverse; }
    [dir="rtl"] .confirm-row .value { text-align: left; }
    [dir="rtl"] .step-bar { flex-direction: row-reverse; }
    [dir="rtl"] .home-card .card-icon { margin-left: 0; }

    /* ===== HOME SCREEN ===== */
    #screen-home .app-header { background: var(--primary-dark); }
    .home-welcome {
      text-align: center;
      padding: 32px 16px 16px;
      color: white;
      background: linear-gradient(160deg, var(--primary-dark) 0%, var(--primary) 100%);
    }
    .home-welcome .material-icons { font-size: 64px; opacity: 0.9; }
    .home-welcome h2 { font-size: 22px; margin-top: 8px; font-weight: 500; }
    .home-welcome p { font-size: 14px; opacity: 0.8; margin-top: 4px; }
    .home-cards { padding: 24px 16px; display: grid; gap: 16px; }
    .home-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px 20px;
      min-height: 80px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s;
      border-left: 4px solid var(--primary);
      text-decoration: none;
      color: inherit;
    }
    .home-card:active { transform: scale(0.98); box-shadow: var(--shadow-md); }
    .home-card .card-icon {
      width: 52px; height: 52px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .home-card.start .card-icon { background: var(--primary-pale); color: var(--primary); }
    .home-card.end .card-icon   { background: var(--success-light); color: var(--success); }
    .home-card.end   { border-left-color: var(--success); }
    .home-card .card-icon .material-icons { font-size: 28px; }
    .home-card h3 { font-size: 17px; font-weight: 500; margin-bottom: 2px; }
    .home-card p  { font-size: 13px; color: var(--text-secondary); }

    /* ===== SCREEN HEADER ===== */
    .screen-header {
      background: var(--primary-dark);
      color: white;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .screen-header h2 { font-size: 17px; font-weight: 500; flex: 1; }
    .screen-header .btn-icon { color: white; }

    /* ===== STEP INDICATOR ===== */
    .step-bar {
      background: var(--primary);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: rgba(255,255,255,0.6);
      font-size: 13px;
    }
    .step-item.active { color: white; font-weight: 500; }
    .step-item.done   { color: rgba(255,255,255,0.8); }
    .step-dot {
      width: 22px; height: 22px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700; color: white;
      flex-shrink: 0;
    }
    .step-item.active .step-dot { background: white; color: var(--primary); }
    .step-item.done .step-dot   { background: rgba(255,255,255,0.4); }
    .step-connector { width: 24px; height: 2px; background: rgba(255,255,255,0.3); }

    /* ===== FORM ELEMENTS ===== */
    .field-group { margin-bottom: 18px; }
    .field-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .field-group .required { color: var(--error); }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 13px 14px;
      font-size: 16px;
      font-family: 'Roboto', sans-serif;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      outline: none;
      background: #FAFAFA;
      color: #212121;
      transition: border-color 0.2s, background 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }
    input:focus, select:focus {
      border-color: var(--primary);
      background: white;
    }
    input[readonly] {
      background: #F5F5F5;
      color: var(--text-secondary);
      cursor: default;
    }
    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .field-row.triple { grid-template-columns: 1fr 1fr 1fr; }

    /* ===== AUTOCOMPLETE ===== */
    .autocomplete-wrapper { position: relative; }
    .autocomplete-list {
      position: absolute;
      top: calc(100% + 4px);
      left: 0; right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      max-height: 220px;
      overflow-y: auto;
      z-index: 200;
      box-shadow: var(--shadow-md);
    }
    .ac-item {
      padding: 12px 14px;
      cursor: pointer;
      font-size: 15px;
      border-bottom: 1px solid #F5F5F5;
      transition: background 0.1s;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:hover, .ac-item.focused { background: var(--primary-pale); }
    .ac-item .ac-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .ac-empty {
      padding: 14px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ===== BUTTONS ===== */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 50px;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 500;
      font-family: 'Roboto', sans-serif;
      cursor: pointer;
      border: none;
      width: 100%;
      transition: opacity 0.15s, transform 0.1s;
      letter-spacing: 0.3px;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-light); }
    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    .btn-success { background: var(--success); color: white; }
    .btn-danger  { background: var(--error); color: white; }

    /* ===== CAMERA ===== */
    .camera-wrapper {
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: #111;
      position: relative;
      aspect-ratio: 4/3;
    }
    .camera-wrapper video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .capture-btn {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 64px; height: 64px;
      border-radius: 50%;
      background: white;
      border: 5px solid var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .capture-btn:active { transform: translateX(-50%) scale(0.92); }
    .capture-btn .material-icons { font-size: 28px; color: var(--primary); }
    .camera-error {
      width: 100%;
      aspect-ratio: 4/3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #1A1A1A;
      color: #aaa;
      border-radius: var(--radius-sm);
      gap: 8px;
      font-size: 14px;
      text-align: center;
      padding: 16px;
    }
    .camera-error .material-icons { font-size: 48px; color: #555; }

    /* ===== CUSTOM 24H DATETIME PICKER ===== */
    .dt-picker { display: flex; gap: 6px; align-items: center; }
    .dt-picker .dt-date { flex: 1; min-width: 0; }
    .dt-picker .dt-hour,
    .dt-picker .dt-min  { width: 68px; flex-shrink: 0; padding-left: 8px; }
    .dt-picker .dt-colon { font-weight: 700; color: var(--text-primary); font-size: 18px; flex-shrink: 0; }
    .photo-preview-wrap {
      position: relative;
      display: inline-block;
    }
    .photo-preview-wrap img {
      width: 100%;
      border-radius: var(--radius-sm);
      border: 2px solid var(--success);
      display: block;
      max-height: 240px;
      object-fit: cover;
    }
    .photo-badge {
      position: absolute;
      top: 8px; right: 8px;
      background: var(--success);
      color: white;
      border-radius: 16px;
      padding: 3px 10px;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .camera-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .camera-note .material-icons { font-size: 14px; }

    /* ===== INFO BOX ===== */
    .info-box {
      background: var(--primary-pale);
      border-left: 3px solid var(--primary);
      border-radius: 4px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--primary);
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 16px;
    }
    .info-box .material-icons { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
    .success-box {
      background: var(--success-light);
      border-left: 3px solid var(--success);
      border-radius: 4px;
      padding: 12px 14px;
      font-size: 14px;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    /* ===== CONFIRMATION CARD ===== */
    .confirm-grid { display: grid; gap: 10px; margin-bottom: 16px; }
    .confirm-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .confirm-row:last-child { border-bottom: none; }
    .confirm-row .label { color: var(--text-secondary); flex-shrink: 0; width: 45%; }
    .confirm-row .value { font-weight: 500; text-align: right; flex: 1; word-break: break-word; }

    /* ===== SECTION TITLE ===== */
    .section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    /* ===== TOAST ===== */
    #toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 240px;
      max-width: calc(100vw - 32px);
      background: #323232;
      color: white;
      padding: 13px 20px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    #toast-container.show  { opacity: 1; }
    #toast-container.error { background: var(--error); }
    #toast-container.success { background: var(--success); }
    #toast-container.warning { background: var(--warning); }

    /* ===== LOADING OVERLAY ===== */
    #loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      gap: 14px;
      color: white;
      font-size: 15px;
    }
    .spinner {
      width: 48px; height: 48px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== SUCCESS SCREEN ===== */
    #screen-success {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 32px 24px;
      background: white;
    }
    .success-icon { font-size: 80px; color: var(--success); }
    #screen-success h2 { font-size: 22px; margin: 16px 0 8px; color: #212121; }
    #screen-success p  { color: var(--text-secondary); margin-bottom: 24px; font-size: 15px; }

    /* ===== DASHBOARD ===== */
    #dashboard-app {
      min-height: 100vh;
      background: #EEF2F7;
    }
    .dash-header {
      background: var(--primary-dark);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .dash-header h1 { font-size: 20px; font-weight: 500; flex: 1; }
    .dash-header .material-icons { font-size: 28px; }
    .dash-updated {
      font-size: 12px;
      opacity: 0.7;
      margin-right: 8px;
    }
    .dash-body { padding: 20px; max-width: 1400px; margin: 0 auto; }
    .dash-date-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Stat cards grid */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .stat-icon {
      width: 52px; height: 52px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .stat-icon .material-icons { font-size: 26px; }
    .stat-icon.blue   { background: var(--primary-pale);  color: var(--primary); }
    .stat-icon.green  { background: var(--success-light); color: var(--success); }
    .stat-icon.orange { background: var(--warning-light); color: var(--warning); }
    .stat-icon.red    { background: var(--error-light);   color: var(--error); }
    .stat-text .number {
      font-size: 32px;
      font-weight: 700;
      color: #212121;
      line-height: 1;
    }
    .stat-text .label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Chart cards */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .chart-card {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .chart-card h3 { font-size: 15px; font-weight: 500; margin-bottom: 16px; color: #212121; }
    .chart-card canvas { max-height: 260px; }

    /* Tables */
    .table-section {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .table-section-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .table-section-header h3 { font-size: 15px; font-weight: 500; flex: 1; }
    .table-section-header .material-icons { color: var(--text-secondary); font-size: 20px; }
    .badge {
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }
    .badge-count { background: var(--primary-pale); color: var(--primary); }
    .badge-overtime { background: var(--error-light); color: var(--error); }
    .badge-ok       { background: var(--success-light); color: var(--success); }
    .badge-miss     { background: var(--warning-light); color: var(--warning); }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th {
      padding: 11px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #FAFAFA;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody td {
      padding: 13px 16px;
      border-bottom: 1px solid #F5F5F5;
      vertical-align: middle;
    }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: #FAFAFA; }
    .no-data {
      text-align: center;
      padding: 28px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    .no-data .material-icons { font-size: 36px; display: block; margin-bottom: 8px; opacity: 0.4; }
    .overtime-row td { background: var(--error-light) !important; }
    .running-time { font-weight: 700; }
    .running-time.over { color: var(--error); }
    /* Stage badges for active drivers table */
    .badge-stage1 { background: #FFF3E0; color: #E65100; }
    .badge-stage2 { background: var(--primary-pale); color: var(--primary); }
    .badge-stage3 { background: var(--success-light); color: var(--success); }
    /* Dashboard section headers */
    .dash-section { margin-bottom: 28px; }
    .dash-section-title {
      font-size: 13px; font-weight: 700; color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 0.8px;
      margin-bottom: 12px; padding-bottom: 6px;
      border-bottom: 2px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }
    .dash-section-title .material-icons { font-size: 18px; }
    /* Date selector row for vehicle/stage timing sections */
    .date-selector-row {
      display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;
    }
    .date-selector-row label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
    .date-selector-row input[type="date"] {
      padding: 7px 10px; font-size: 14px; border: 1.5px solid var(--border);
      border-radius: var(--radius-sm); background: white; width: auto;
    }
    /* Drill-down rows for failed drops table */
    .drill-row td { padding: 6px 16px; font-size: 13px; color: var(--text-secondary); background: #FAFAFA; }

    /* Helper companies */
    .company-list { padding: 12px 20px 16px; }
    .company-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #F5F5F5;
    }
    .company-item:last-child { border-bottom: none; }
    .company-bar-wrap { flex: 1; background: #F0F0F0; border-radius: 4px; height: 8px; }
    .company-bar { height: 8px; border-radius: 4px; background: var(--primary); }
    .company-name { min-width: 120px; font-size: 14px; }
    .company-count { font-size: 13px; font-weight: 700; color: var(--primary); min-width: 32px; text-align: right; }

    /* ===== SPLASH SCREEN ===== */
    #splash-screen {
      position: fixed;
      inset: 0;
      background: var(--primary-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      transition: opacity 0.6s ease;
    }
    #splash-screen.fade-out { opacity: 0; pointer-events: none; }
    .splash-icon-wrap {
      margin-bottom: 28px;
      animation: splash-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
    }
    .splash-icon-wrap img { width: 96px; height: 96px; border-radius: 22px; }
    .splash-brand {
      font-size: 28px;
      font-weight: 700;
      color: white;
      letter-spacing: 0.5px;
      animation: splash-fade-up 0.5s 0.2s ease both;
    }
    .splash-sub {
      font-size: 13px;
      color: rgba(255,255,255,0.65);
      margin-top: 6px;
      letter-spacing: 2px;
      text-transform: uppercase;
      animation: splash-fade-up 0.5s 0.3s ease both;
    }
    .splash-dots {
      display: flex;
      gap: 10px;
      margin-top: 40px;
      animation: splash-fade-up 0.5s 0.4s ease both;
    }
    .splash-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.35);
      animation: dot-pulse 1.4s ease-in-out infinite;
    }
    .splash-dot:nth-child(2) { animation-delay: 0.22s; }
    .splash-dot:nth-child(3) { animation-delay: 0.44s; }
    @keyframes dot-pulse {
      0%, 80%, 100% { transform: scale(0.85); opacity: 0.35; }
      40%            { transform: scale(1.3);  opacity: 1; }
    }
    @keyframes splash-pop {
      from { transform: scale(0.7); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }
    @keyframes splash-fade-up {
      from { transform: translateY(12px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }

    /* ===== HELPER MODE TOGGLE ===== */
    .mode-toggle {
      display: flex;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      margin-bottom: 16px;
    }
    .mode-toggle-btn {
      flex: 1;
      padding: 10px 8px;
      min-height: 48px;
      font-size: 14px;
      font-weight: 500;
      font-family: 'Roboto', sans-serif;
      background: #FAFAFA;
      color: var(--text-secondary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s, color 0.15s;
      border-right: 1.5px solid var(--border);
    }
    .mode-toggle-btn:last-child { border-right: none; }
    .mode-toggle-btn.active { background: var(--primary); color: white; }
    .mode-toggle-btn .material-icons { font-size: 18px; }

    /* Responsive tweaks */
    @media (max-width: 480px) {
      .stat-grid { grid-template-columns: 1fr 1fr; }
      .chart-grid { grid-template-columns: 1fr; }
      .dash-body  { padding: 12px; }
    }
  </style>
</head>
<body>

<!-- ===== SERVER-INJECTED DATA ===== -->
<script>
  var APP_DATA           = <?!= initialData ?>;
  var APP_VIEW           = '<?!= view ?>';
  var APP_DEPLOYMENT_URL = '<?!= deploymentUrl ?>';
  // Set PWA manifest link now (before DOMContentLoaded for faster browser pickup)
  (function() {
    if (APP_DEPLOYMENT_URL) {
      var ml = document.getElementById('pwa-manifest');
      if (ml) ml.href = APP_DEPLOYMENT_URL + '?manifest=1';
    }
  })();
</script>

<!-- ===== SPLASH SCREEN ===== -->
<div id="splash-screen">
  <div class="splash-icon-wrap">
    <img src="<?!= iconDataUri ?>" alt="RSA Transport">
  </div>
  <div class="splash-brand" data-i18n="brand">RSA Transport</div>
  <div class="splash-sub" data-i18n="appTitle">RSA Driver App</div>
  <div class="splash-dots">
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
  </div>
</div>

<!-- ===== DRIVER APP ===== -->
<div id="driver-app">

  <!-- HOME -->
  <div id="screen-home" class="hidden">
    <div class="app-header">
      <span class="material-icons">local_shipping</span>
      <h1 data-i18n="appTitle">RSA Driver App</h1>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLanguage('en')" type="button">EN</button>
        <button class="lang-btn" onclick="setLanguage('hi')" type="button">हिं</button>
        <button class="lang-btn" onclick="setLanguage('ar')" type="button">عر</button>
        <button class="lang-btn" onclick="setLanguage('ur')" type="button">اُر</button>
      </div>
    </div>
    <div class="home-welcome">
      <span class="material-icons">fact_check</span>
      <h2 data-i18n="brand">RSA Transport</h2>
      <p data-i18n="homeSubtitle">Shift Management System</p>
    </div>
    <div class="home-cards">
      <!-- Step 1 -->
      <div class="home-card start" onclick="navigate('sos-stage1')">
        <div class="card-icon" style="background:var(--primary-pale);color:var(--primary)">
          <span class="material-icons">warehouse</span>
        </div>
        <div>
          <h3 data-i18n="card1Title">Arrived at Warehouse</h3>
          <p data-i18n="card1Sub">Stage 1 — Register your shift &amp; odometer</p>
        </div>
        <span class="material-icons" style="color:#ccc;margin-left:auto;">chevron_right</span>
      </div>
      <!-- Step 2 -->
      <div class="home-card" style="border-left-color:#F57F17" onclick="navigate('sos-stage2')">
        <div class="card-icon" style="background:#FFF3E0;color:#E65100">
          <span class="material-icons">exit_to_app</span>
        </div>
        <div>
          <h3 data-i18n="card2Title">Leaving Warehouse</h3>
          <p data-i18n="card2Sub">Stage 2 — Record your departure time</p>
        </div>
        <span class="material-icons" style="color:#ccc;margin-left:auto;">chevron_right</span>
      </div>
      <!-- Step 3 — Last Drop -->
      <div class="home-card end" onclick="navigate('eos-stage3')">
        <div class="card-icon">
          <span class="material-icons">local_shipping</span>
        </div>
        <div>
          <h3 data-i18n="card3Title">Last Drop</h3>
          <p data-i18n="card3Sub">Stage 3 — Record last drop &amp; odometer photo</p>
        </div>
        <span class="material-icons" style="color:#ccc;margin-left:auto;">chevron_right</span>
      </div>
      <!-- Step 4 — Shift Complete -->
      <div class="home-card" style="border-left-color:#2E7D32" onclick="navigate('eos-stage4')">
        <div class="card-icon" style="background:#E8F5E9;color:#2E7D32">
          <span class="material-icons">stop_circle</span>
        </div>
        <div>
          <h3 data-i18n="card4Title">Shift Complete</h3>
          <p data-i18n="card4Sub">Stage 4 — Odometer reading &amp; shift close</p>
        </div>
        <span class="material-icons" style="color:#ccc;margin-left:auto;">chevron_right</span>
      </div>
    </div>
    <div style="text-align:center;padding:12px 16px 8px;">
      <a id="dash-link" href="#" onclick="openDashboard();return false;"
        style="font-size:13px;color:var(--primary);text-decoration:none;display:inline-flex;align-items:center;gap:4px;">
        <span class="material-icons" style="font-size:16px">dashboard</span>
        <span data-i18n="dashLink">View Operations Dashboard</span>
      </a>
    </div>
    <div style="text-align:center;padding:4px;font-size:12px;color:#999;">
      <span data-i18n="timezone">Time zone: Asia/Dubai (UTC+4)</span>
    </div>
  </div>

  <!-- START OF SHIFT — STAGE 1 -->
  <div id="screen-sos-stage1" class="hidden">
    <div class="screen-header">
      <button class="btn-icon" onclick="navigate('home')" aria-label="Back">
        <span class="material-icons">arrow_back</span>
      </button>
      <h2 data-i18n="s1Header">Start of Shift</h2>
    </div>
    <div class="step-bar">
      <div class="step-item active" id="sos-step1">
        <div class="step-dot">1</div><span data-i18n="step1">At Warehouse</span>
      </div>
      <div class="step-connector"></div>
      <div class="step-item" id="sos-step2">
        <div class="step-dot">2</div><span data-i18n="step2">Departure</span>
      </div>
    </div>
    <div style="padding:16px">

      <!-- Driver -->
      <div class="card">
        <p class="section-title" data-i18n="driverDetails">Driver Details</p>
        <!-- Search area (hidden after selection) -->
        <div class="field-group" id="sos1-driver-search-area">
          <label><span data-i18n="searchDriver">Driver</span> <span class="required">*</span></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="sos1-driver-search"
              data-i18n-placeholder="searchDriverPh"
              placeholder="Search by name or employee ID"
              autocomplete="off"
              oninput="doAutocomplete(this,'drivers',onDriverSelect)"
              onkeydown="acKeyNav(event,'sos1-driver-list')">
            <div id="sos1-driver-list" class="autocomplete-list hidden"></div>
          </div>
        </div>
        <!-- Selection chip (shown after driver selected) -->
        <div id="sos1-driver-chip" class="driver-chip hidden">
          <span class="material-icons chip-icon">person</span>
          <div class="chip-info">
            <div class="chip-name" id="sos1-chip-name"></div>
            <div class="chip-id" id="sos1-chip-id"></div>
          </div>
          <button class="chip-clear" onclick="clearDriverSelection()" type="button" aria-label="Change driver">
            <span class="material-icons">close</span>
          </button>
        </div>
        <!-- Hidden inputs for form submission -->
        <input type="hidden" id="sos1-driver-id">
        <input type="hidden" id="sos1-driver-name">
      </div>

      <!-- Helper -->
      <div class="card">
        <p class="section-title"><span data-i18n="helperDetails">Helper Details</span> <span class="required">*</span></p>
        <!-- Mode toggle -->
        <div class="mode-toggle">
          <button class="mode-toggle-btn active" id="helper-mode-search" type="button"
            onclick="toggleHelperMode('search')">
            <span class="material-icons">search</span> <span data-i18n="fromList">From List</span>
          </button>
          <button class="mode-toggle-btn" id="helper-mode-manual" type="button"
            onclick="toggleHelperMode('manual')">
            <span class="material-icons">edit</span> <span data-i18n="manualEntry">Manual Entry</span>
          </button>
        </div>

        <!-- From List panel -->
        <div id="helper-panel-search">
          <div class="field-group">
            <label data-i18n="searchHelper">Search Helper</label>
            <div class="autocomplete-wrapper">
              <input type="text" id="sos1-helper-search"
                data-i18n-placeholder="searchHelperPh"
                placeholder="Type name or employee ID"
                autocomplete="off" oninput="doAutocomplete(this,'helpers',onHelperSelect)"
                onkeydown="acKeyNav(event,'sos1-helper-list')">
              <div id="sos1-helper-list" class="autocomplete-list hidden"></div>
            </div>
          </div>
          <div class="field-row triple">
            <div class="field-group" style="margin-bottom:0">
              <label>ID</label>
              <input type="text" id="sos1-helper-id" readonly placeholder="Auto">
            </div>
            <div class="field-group" style="margin-bottom:0">
              <label>Name</label>
              <input type="text" id="sos1-helper-name" readonly placeholder="Auto">
            </div>
            <div class="field-group" style="margin-bottom:0">
              <label>Company</label>
              <input type="text" id="sos1-helper-company" readonly placeholder="Auto">
            </div>
          </div>
        </div>

        <!-- Manual Entry panel -->
        <div id="helper-panel-manual" class="hidden">
          <div class="field-group">
            <label><span data-i18n="supplierCompany">Supplier Company</span> <span class="required">*</span></label>
            <select id="sos1-helper-company-manual" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:15px;background:var(--surface);color:var(--text-primary);appearance:none;-webkit-appearance:none;background-image:url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E\");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;">
              <option value="" disabled selected data-i18n="supplierCompanyPh">Select supplier company</option>
            </select>
          </div>
          <div class="field-group" style="margin-bottom:0">
            <label><span data-i18n="helperNameOptional">Helper Name (optional)</span></label>
            <input type="text" id="sos1-helper-name-manual"
              data-i18n-placeholder="helperNamePh"
              placeholder="Enter helper name if known">
          </div>
        </div>
      </div>

      <!-- Vehicle & Odometer -->
      <div class="card">
        <p class="section-title" data-i18n="vehicleOdo">Vehicle &amp; Odometer</p>
        <div class="field-group">
          <label><span data-i18n="vehicleNum">Vehicle Number</span> <span class="required">*</span></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="sos1-vehicle-search"
              data-i18n-placeholder="vehiclePh"
              placeholder="Type to search vehicle"
              autocomplete="off" oninput="doAutocomplete(this,'vehicles',onVehicleSelect)"
              onkeydown="acKeyNav(event,'sos1-vehicle-list')">
            <div id="sos1-vehicle-list" class="autocomplete-list hidden"></div>
          </div>
          <input type="text" id="sos1-vehicle-number" readonly placeholder="Selected vehicle"
            style="margin-top:8px;background:#F5F5F5">
        </div>
        <div class="field-group">
          <label><span data-i18n="startOdo">Start Odometer (km)</span> <span class="required">*</span></label>
          <input type="number" id="sos1-odometer"
            data-i18n-placeholder="startOdoPh"
            placeholder="e.g. 123456" min="0">
        </div>
        <div class="field-group">
          <label><span data-i18n="odoPhoto">Odometer Photo</span> <span class="required">*</span></label>
          <div id="camera-area-start">
            <div id="camera-wrapper-start" class="camera-wrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px">
              <input type="file" id="camera-input-start" accept="image/*" capture="environment" style="display:none" onchange="onPhotoSelected('start',this)">
              <span class="material-icons" style="font-size:52px;color:#555">camera_alt</span>
              <button class="btn btn-primary" onclick="document.getElementById('camera-input-start').click()" type="button" style="font-size:14px;padding:10px 22px">
                <span class="material-icons" style="font-size:18px;vertical-align:middle">camera</span> Take Photo
              </button>
            </div>
          </div>
          <div id="photo-result-start" class="hidden" style="margin-top:8px">
            <div class="photo-preview-wrap">
              <img id="photo-img-start" alt="Odometer photo">
              <div class="photo-badge"><span class="material-icons" style="font-size:14px">check</span> Captured</div>
            </div>
            <button class="btn btn-secondary" style="margin-top:8px" onclick="retakePhoto('start')" type="button">
              <span class="material-icons">replay</span> Retake Photo
            </button>
          </div>
          <p class="camera-note">
            <span class="material-icons">info</span>
            <span data-i18n="cameraNote">Camera only &mdash; file upload not allowed</span>
          </p>
        </div>
        <div class="field-group" style="margin-bottom:0">
          <label data-i18n="fuelTaken">Fuel Taken</label>
          <input type="number" id="sos1-fuel"
            data-i18n-placeholder="fuelPh"
            placeholder="e.g. 40" min="0" step="0.5">
        </div>
      </div>

      <!-- Shift Start Time -->
      <div class="card">
        <p class="section-title" data-i18n="shiftStartSection">Shift Start Time</p>
        <div class="field-group" style="margin-bottom:0">
          <label><span data-i18n="arrivalLabel">Arrival at Gate Date &amp; Time</span> <span class="required">*</span></label>
          <div class="dt-picker">
            <input type="date" id="sos1-shift-start-time-d" class="dt-date">
            <select id="sos1-shift-start-time-h" class="dt-hour"></select>
            <span class="dt-colon">:</span>
            <select id="sos1-shift-start-time-m" class="dt-min"></select>
          </div>
          <p style="font-size:12px;color:var(--text-secondary);margin-top:4px">
            Enter the actual time you arrived at the gate. Device should be on Asia/Dubai timezone (UTC+4).
          </p>
        </div>
      </div>

      <!-- Route & Drop Info -->
      <div class="card">
        <p class="section-title" data-i18n="routeInfo">Route &amp; Drop Info</p>
        <div class="field-group">
          <label><span data-i18n="destinationEmirate">Destination Emirate</span> <span class="required">*</span></label>
          <select id="sos1-destination" style="width:100%;padding:12px;font-size:15px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:#fff;color:#212121;">
            <option value="" data-i18n-option="destinationEmiratePh">-- Select Emirate --</option>
          </select>
        </div>
        <div class="field-group">
          <label><span data-i18n="primaryCustomer">Primary Customer Name</span> <span class="required">*</span></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="sos1-customer-search"
              data-i18n-placeholder="primaryCustomerPh"
              placeholder="Search customer name"
              autocomplete="off"
              oninput="doAutocomplete(this,'customers',onCustomerSelect)"
              onkeydown="acKeyNav(event,'sos1-customer-list')">
            <div id="sos1-customer-list" class="autocomplete-list hidden"></div>
          </div>
          <input type="hidden" id="sos1-customer-name">
        </div>
        <div class="field-group" style="margin-bottom:0">
          <label><span data-i18n="totalDrops">Total Drops</span> <span class="required">*</span></label>
          <input type="number" id="sos1-total-drops"
            data-i18n-placeholder="totalDropsPh"
            placeholder="e.g. 25" min="0">
        </div>
      </div>

      <button class="btn btn-primary" id="btn-sos1-submit" onclick="submitStage1()" type="button">
        <span class="material-icons">save</span> <span data-i18n="saveContinue">Save &amp; Continue to Stage 2</span>
      </button>
    </div>
  </div>

  <!-- START OF SHIFT — STAGE 2 -->
  <div id="screen-sos-stage2" class="hidden">
    <div class="screen-header">
      <button class="btn-icon" onclick="navigate('home')" aria-label="Home">
        <span class="material-icons">home</span>
      </button>
      <h2 data-i18n="s2Header">Start of Shift — Departure</h2>
    </div>
    <div class="step-bar">
      <div class="step-item done" id="sos2-step1">
        <div class="step-dot"><span class="material-icons" style="font-size:14px">check</span></div><span data-i18n="step1">At Warehouse</span>
      </div>
      <div class="step-connector"></div>
      <div class="step-item active" id="sos2-step2">
        <div class="step-dot">2</div><span data-i18n="step2">Departure</span>
      </div>
    </div>
    <div style="padding:16px">
      <div class="success-box">
        <span class="material-icons">check_circle</span>
        <span data-i18n="s1Saved">Stage 1 saved! Complete this step when leaving the warehouse.</span>
      </div>

      <div class="card">
        <p class="section-title" data-i18n="confirmIdentity">Confirm Your Identity</p>
        <div class="field-group">
          <label><span data-i18n="searchYourName">Search Your Name</span> <span class="required">*</span></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="sos2-driver-search"
              data-i18n-placeholder="searchDriverPh"
              placeholder="Type your name or ID"
              autocomplete="off" oninput="doAutocomplete(this,'stage1Drivers',onStage2DriverSelect)"
              onkeydown="acKeyNav(event,'sos2-driver-list')">
            <div id="sos2-driver-list" class="autocomplete-list hidden"></div>
          </div>
          <div id="sos2-loading-drivers" class="hidden" style="font-size:13px;color:var(--text-secondary);margin-top:6px;display:flex;align-items:center;gap:6px;">
            <div style="width:14px;height:14px;border:2px solid #ccc;border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
            Loading drivers...
          </div>
          <p style="font-size:12px;color:var(--text-secondary);margin-top:6px" data-i18n="stage1Note">
            Only drivers who completed Stage 1 are shown here.
          </p>
          <button onclick="loadStage1PendingDrivers()" type="button"
            style="font-size:12px;color:var(--primary);background:none;border:none;cursor:pointer;padding:4px 0;display:flex;align-items:center;gap:4px;margin-top:4px;">
            <span class="material-icons" style="font-size:15px">refresh</span> <span data-i18n="refreshList">Refresh list</span>
          </button>
        </div>

        <div id="sos2-confirm-details" class="hidden">
          <div class="confirm-grid">
            <div class="confirm-row">
              <span class="label" data-i18n="driverLabel">Driver</span>
              <span class="value" id="sos2-c-driver"></span>
            </div>
            <div class="confirm-row">
              <span class="label" data-i18n="helperLabel">Helper</span>
              <span class="value" id="sos2-c-helper"></span>
            </div>
            <div class="confirm-row">
              <span class="label" data-i18n="vehicleLabel">Vehicle</span>
              <span class="value" id="sos2-c-vehicle"></span>
            </div>
            <div class="confirm-row">
              <span class="label" data-i18n="arrivedAt">Arrived at</span>
              <span class="value" id="sos2-c-arrival"></span>
            </div>
          </div>
          <div class="field-group" style="margin-top:12px">
            <label><span data-i18n="departureLabel">Departure Date &amp; Time</span> <span class="required">*</span></label>
            <div class="dt-picker">
              <input type="date" id="sos2-departure-time-d" class="dt-date">
              <select id="sos2-departure-time-h" class="dt-hour"></select>
              <span class="dt-colon">:</span>
              <select id="sos2-departure-time-m" class="dt-min"></select>
            </div>
            <p style="font-size:12px;color:var(--text-secondary);margin-top:4px">
              Enter the actual time you left the warehouse. Device should be on Asia/Dubai timezone (UTC+4).
            </p>
          </div>
          <button class="btn btn-primary" id="btn-sos2-submit" onclick="submitStage2()" type="button">
            <span class="material-icons">exit_to_app</span> <span data-i18n="recordDeparture">Confirm Departure</span>
          </button>
        </div>
      </div>

      <button class="btn btn-secondary" onclick="navigate('sos-stage1')" type="button" style="margin-top:4px">
        <span class="material-icons">arrow_back</span> Back to Stage 1 Form
      </button>
    </div>
  </div>

  <!-- STAGE 3 — LAST DROP -->
  <div id="screen-eos-stage3" class="hidden">
    <div class="screen-header">
      <button class="btn-icon" onclick="navigate('home')" aria-label="Back">
        <span class="material-icons">arrow_back</span>
      </button>
      <h2 data-i18n="eos3Header">Last Drop — Stage 3</h2>
    </div>
    <div style="padding:16px">

      <div class="card">
        <p class="section-title" data-i18n="selectDriver">Select Driver</p>
        <div class="field-group">
          <label><span data-i18n="searchYourName">Search Your Name</span> <span class="required">*</span></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="eos3-driver-search"
              data-i18n-placeholder="searchDriverPh"
              placeholder="Type your name or ID"
              autocomplete="off" oninput="doAutocomplete(this,'activeDrivers',onEos3DriverSelect)"
              onkeydown="acKeyNav(event,'eos3-driver-list')">
            <div id="eos3-driver-list" class="autocomplete-list hidden"></div>
          </div>
          <div id="eos3-loading-drivers" class="hidden" style="font-size:13px;color:var(--text-secondary);margin-top:6px;display:flex;align-items:center;gap:6px;">
            <div style="width:14px;height:14px;border:2px solid #ccc;border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
            Loading active drivers...
          </div>
          <p style="font-size:12px;color:var(--text-secondary);margin-top:6px" data-i18n="eosDriverNote">
            All drivers with an active shift are shown (including those who skipped Stage 2).
          </p>
          <button onclick="loadActiveDrivers()" type="button"
            style="font-size:12px;color:var(--primary);background:none;border:none;cursor:pointer;padding:4px 0;display:flex;align-items:center;gap:4px;margin-top:4px;">
            <span class="material-icons" style="font-size:15px">refresh</span> <span data-i18n="refreshList">Refresh list</span>
          </button>
        </div>
      </div>

      <div id="eos3-form" class="hidden">
        <div class="card">
          <p class="section-title" data-i18n="dropDetails">Drop Details</p>
          <div class="field-group">
            <label><span data-i18n="lastDrop">Last Drop Date &amp; Time</span> <span class="required">*</span></label>
            <div class="dt-picker">
              <input type="date" id="eos3-last-drop-d" class="dt-date">
              <select id="eos3-last-drop-h" class="dt-hour"></select>
              <span class="dt-colon">:</span>
              <select id="eos3-last-drop-m" class="dt-min"></select>
            </div>
            <p style="font-size:12px;color:var(--text-secondary);margin-top:4px">
              Ensure your device is set to Asia/Dubai timezone (UTC+4).
            </p>
          </div>
          <div class="field-group">
            <label><span data-i18n="lastDropPhoto">Last Drop Odometer Photo</span> <span class="required">*</span></label>
            <div id="camera-area-lastDrop">
              <div id="camera-wrapper-lastDrop" class="camera-wrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px">
                <input type="file" id="camera-input-lastDrop" accept="image/*" capture="environment" style="display:none" onchange="onPhotoSelected('lastDrop',this)">
                <span class="material-icons" style="font-size:52px;color:#555">camera_alt</span>
                <button class="btn btn-primary" onclick="document.getElementById('camera-input-lastDrop').click()" type="button" style="font-size:14px;padding:10px 22px">
                  <span class="material-icons" style="font-size:18px;vertical-align:middle">camera</span> Take Photo
                </button>
              </div>
            </div>
            <div id="photo-result-lastDrop" class="hidden" style="margin-top:8px">
              <div class="photo-preview-wrap">
                <img id="photo-img-lastDrop" alt="Last drop odometer photo">
                <div class="photo-badge"><span class="material-icons" style="font-size:14px">check</span> Captured</div>
              </div>
              <button class="btn btn-secondary" style="margin-top:8px" onclick="retakePhoto('lastDrop')" type="button">
                <span class="material-icons">replay</span> Retake Photo
              </button>
            </div>
            <p class="camera-note">
              <span class="material-icons">info</span>
              <span data-i18n="cameraNote">Camera only &mdash; file upload not allowed</span>
            </p>
          </div>
          <div class="field-group" style="margin-bottom:0">
            <label><span data-i18n="failedDrops">Number of Failed Drops</span> <span class="required">*</span></label>
            <input type="number" id="eos3-failed-drops" min="0" value="0">
          </div>
        </div>

        <button class="btn btn-primary" id="btn-eos3-submit" onclick="submitStage3()" type="button">
          <span class="material-icons">save</span> <span data-i18n="saveLastDrop">Save Last Drop</span>
        </button>
      </div>
    </div>
  </div>

  <!-- STAGE 4 — SHIFT COMPLETE -->
  <div id="screen-eos-stage4" class="hidden">
    <div class="screen-header">
      <button class="btn-icon" onclick="navigate('home')" aria-label="Back">
        <span class="material-icons">arrow_back</span>
      </button>
      <h2 data-i18n="eos4Header">Shift Complete — Stage 4</h2>
    </div>
    <div style="padding:16px">

      <div class="card">
        <p class="section-title" data-i18n="selectDriver">Select Driver</p>
        <div class="field-group">
          <label><span data-i18n="searchYourName">Search Your Name</span> <span class="required">*</span></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="eos4-driver-search"
              data-i18n-placeholder="searchDriverPh"
              placeholder="Type your name or ID"
              autocomplete="off" oninput="doAutocomplete(this,'stage3Drivers',onEos4DriverSelect)"
              onkeydown="acKeyNav(event,'eos4-driver-list')">
            <div id="eos4-driver-list" class="autocomplete-list hidden"></div>
          </div>
          <div id="eos4-loading-drivers" class="hidden" style="font-size:13px;color:var(--text-secondary);margin-top:6px;display:flex;align-items:center;gap:6px;">
            <div style="width:14px;height:14px;border:2px solid #ccc;border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
            Loading drivers...
          </div>
          <p style="font-size:12px;color:var(--text-secondary);margin-top:6px" data-i18n="eos4DriverNote">
            Drivers who completed Stage 3 are shown here.
          </p>
          <button onclick="loadStage3Drivers()" type="button"
            style="font-size:12px;color:var(--primary);background:none;border:none;cursor:pointer;padding:4px 0;display:flex;align-items:center;gap:4px;margin-top:4px;">
            <span class="material-icons" style="font-size:15px">refresh</span> <span data-i18n="refreshList">Refresh list</span>
          </button>
        </div>
      </div>

      <div id="eos4-form" class="hidden">
        <!-- End Odometer -->
        <div class="card">
          <p class="section-title" data-i18n="endOdoSection">End Odometer &amp; Photo</p>
          <div class="field-group">
            <label><span data-i18n="endOdo">End Odometer (km)</span> <span class="required">*</span></label>
            <input type="number" id="eos4-odometer"
              data-i18n-placeholder="endOdoPh"
              placeholder="e.g. 124500" min="0">
          </div>
          <div class="field-group" style="margin-bottom:0">
            <label><span data-i18n="odoPhoto">Odometer Photo</span> <span class="required">*</span></label>
            <div id="camera-area-end">
              <div id="camera-wrapper-end" class="camera-wrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px">
                <input type="file" id="camera-input-end" accept="image/*" capture="environment" style="display:none" onchange="onPhotoSelected('end',this)">
                <span class="material-icons" style="font-size:52px;color:#555">camera_alt</span>
                <button class="btn btn-primary" onclick="document.getElementById('camera-input-end').click()" type="button" style="font-size:14px;padding:10px 22px">
                  <span class="material-icons" style="font-size:18px;vertical-align:middle">camera</span> Take Photo
                </button>
              </div>
            </div>
            <div id="photo-result-end" class="hidden" style="margin-top:8px">
              <div class="photo-preview-wrap">
                <img id="photo-img-end" alt="End odometer photo">
                <div class="photo-badge"><span class="material-icons" style="font-size:14px">check</span> Captured</div>
              </div>
              <button class="btn btn-secondary" style="margin-top:8px" onclick="retakePhoto('end')" type="button">
                <span class="material-icons">replay</span> Retake Photo
              </button>
            </div>
            <p class="camera-note">
              <span class="material-icons">info</span>
              <span data-i18n="cameraNote">Camera only &mdash; file upload not allowed</span>
            </p>
          </div>
        </div>

        <!-- Shift Complete Time -->
        <div class="card">
          <p class="section-title" data-i18n="shiftCompleteSection">Shift Complete Time</p>
          <div class="field-group" style="margin-bottom:0">
            <label><span data-i18n="shiftComplete">Shift Complete Date &amp; Time</span> <span class="required">*</span></label>
            <div class="dt-picker">
              <input type="date" id="eos4-shift-complete-d" class="dt-date">
              <select id="eos4-shift-complete-h" class="dt-hour"></select>
              <span class="dt-colon">:</span>
              <select id="eos4-shift-complete-m" class="dt-min"></select>
            </div>
            <p style="font-size:12px;color:var(--text-secondary);margin-top:4px">
              Enter the actual time you completed your shift. Device should be on Asia/Dubai timezone (UTC+4).
            </p>
          </div>
        </div>

        <button class="btn btn-success" id="btn-eos4-submit" onclick="submitStage4()" type="button">
          <span class="material-icons">check_circle</span> <span data-i18n="completeShift">Complete Shift</span>
        </button>
      </div>
    </div>
  </div>

  <!-- SUCCESS SCREEN -->
  <div id="screen-success" class="hidden">
    <span class="material-icons success-icon">check_circle</span>
    <h2 id="success-title">Done!</h2>
    <p id="success-msg">Your data has been saved.</p>
    <div id="success-stats" class="hidden" style="margin-bottom:16px;font-size:15px;color:var(--text-secondary)"></div>
    <button class="btn btn-primary" style="max-width:280px" onclick="navigate('home')" type="button">
      <span data-i18n="backHome">Back to Home</span>
    </button>
  </div>

</div><!-- end #driver-app -->

<!-- ===== MASTER DASHBOARD ===== -->
<div id="dashboard-app" class="hidden">
  <div class="dash-header">
    <button class="btn-icon" onclick="navigate('home')" title="Back to App" style="color:white;margin-right:4px">
      <span class="material-icons">arrow_back</span>
    </button>
    <span class="material-icons">dashboard</span>
    <h1>Transport Dashboard</h1>
    <span class="dash-updated" id="dash-updated"></span>
    <button class="btn-icon" onclick="refreshDashboard()" title="Refresh" style="color:white">
      <span class="material-icons">refresh</span>
    </button>
  </div>

  <div class="dash-body">
    <p class="dash-date-label" id="dash-date-label"></p>

    <!-- SECTION 1: Today's Overview -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">bar_chart</span> Today's Overview
      </div>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-icon blue"><span class="material-icons">person_pin</span></div>
          <div class="stat-text">
            <div class="number" id="stat-active">—</div>
            <div class="label">Active Drivers</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><span class="material-icons">check_circle_outline</span></div>
          <div class="stat-text">
            <div class="number" id="stat-completed">—</div>
            <div class="label">Shifts Completed Today</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue"><span class="material-icons">timer</span></div>
          <div class="stat-text">
            <div class="number" id="stat-avg-duration">—</div>
            <div class="label">Avg Shift Duration (hrs)</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange"><span class="material-icons">warning_amber</span></div>
          <div class="stat-text">
            <div class="number" id="stat-failed-drops">—</div>
            <div class="label">Failed Drops Today</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon red"><span class="material-icons">person_off</span></div>
          <div class="stat-text">
            <div class="number" id="stat-punchout">—</div>
            <div class="label">Punch-Out Misses</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 2: Live Operations -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">local_shipping</span> Live Operations
      </div>

      <!-- Active Drivers Table -->
      <div class="table-section" style="margin-bottom:16px">
        <div class="table-section-header">
          <span class="material-icons">directions_car</span>
          <h3>Currently Active Drivers</h3>
          <span class="badge badge-count" id="active-count-badge">0</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Driver</th>
                <th>Vehicle</th>
                <th>Stage</th>
                <th>Arrival</th>
                <th>Running Time</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody-active"></tbody>
          </table>
        </div>
      </div>

      <!-- Punch-Out Misses -->
      <div class="table-section">
        <div class="table-section-header">
          <span class="material-icons">error_outline</span>
          <h3>Punch-Out Misses (Previous Days)</h3>
          <span class="badge badge-miss" id="miss-count-badge">0</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Shift Date</th><th>Driver</th><th>Vehicle</th><th>Stuck At</th></tr>
            </thead>
            <tbody id="tbody-misses"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SECTION 3: Drops Analysis -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">warning_amber</span> Drops Analysis
      </div>
      <div class="table-section">
        <div class="table-section-header">
          <span class="material-icons">analytics</span>
          <h3>Failed Drops by Date</h3>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Date / Driver</th><th>Total Drops</th><th>Failed Drops</th><th>Failure Rate</th><th></th></tr>
            </thead>
            <tbody id="tbody-failed-drops"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SECTION 4: Shift Trends -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">trending_up</span> Shift Trends (Last 30 Days)
      </div>
      <div class="chart-card">
        <h3>Shift Duration Trend</h3>
        <canvas id="chart-trend"></canvas>
      </div>
    </div>

    <!-- SECTION 5: Vehicle Analysis -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">commute</span> Vehicle Analysis
      </div>
      <div class="date-selector-row">
        <label>Date:</label>
        <input type="date" id="vehicle-date-picker">
        <button onclick="loadVehicleKm()" class="btn btn-primary" style="min-height:36px;padding:0 14px;font-size:13px;width:auto">
          <span class="material-icons" style="font-size:16px;vertical-align:middle">refresh</span> Load
        </button>
      </div>
      <div class="chart-grid">
        <div class="chart-card">
          <h3 id="vehicle-km-title">Vehicle km Run — Previous Day</h3>
          <canvas id="chart-vehicle-km"></canvas>
        </div>
        <div class="chart-card">
          <h3 id="vehicle-hours-title">Vehicle Running Hours</h3>
          <div class="date-selector-row" style="margin-top:4px">
            <label>From:</label>
            <input type="date" id="vhours-from-picker">
            <label>To:</label>
            <input type="date" id="vhours-to-picker">
            <button onclick="loadVehicleHours()" class="btn btn-primary" style="min-height:32px;padding:0 12px;font-size:12px;width:auto">
              <span class="material-icons" style="font-size:14px;vertical-align:middle">refresh</span> Load
            </button>
          </div>
          <canvas id="chart-vehicles"></canvas>
        </div>
      </div>
    </div>

    <!-- SECTION 6: Overtime Analysis -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">schedule</span> Overtime Analysis
      </div>
      <div class="table-section">
        <div class="table-section-header">
          <span class="material-icons">more_time</span>
          <h3>Overtime by Date &amp; Driver</h3>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Date</th><th>Driver</th><th>Shift Duration (hrs)</th><th>Overtime (hrs)</th></tr>
            </thead>
            <tbody id="tbody-overtime"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SECTION 7: Stage Timing Breakdown -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">timeline</span> Stage Timing Breakdown
      </div>
      <div class="date-selector-row">
        <label>Date:</label>
        <input type="date" id="stage-timing-date-picker">
        <button onclick="loadStageTimings()" class="btn btn-primary" style="min-height:36px;padding:0 14px;font-size:13px;width:auto">
          <span class="material-icons" style="font-size:16px;vertical-align:middle">refresh</span> Load
        </button>
      </div>
      <div class="table-section">
        <div class="table-section-header">
          <span class="material-icons">alarm</span>
          <h3 id="stage-timing-title">Stage Timing — Previous Day</h3>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Driver</th>
                <th>Vehicle</th>
                <th>Stage 1→2 Gap</th>
                <th>Stage 2→3 Gap</th>
                <th>Stage 3→4 Gap</th>
              </tr>
            </thead>
            <tbody id="tbody-stage-timing"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SECTION 8: Helper Companies -->
    <div class="dash-section">
      <div class="dash-section-title">
        <span class="material-icons">business</span> Helper Companies
      </div>
      <div class="table-section">
        <div class="table-section-header">
          <span class="material-icons">business</span>
          <h3>Top Helper Companies Today</h3>
        </div>
        <div class="company-list" id="company-list"></div>
      </div>
    </div>

  </div>
</div><!-- end #dashboard-app -->

<!-- ===== SHARED UI ===== -->
<div id="toast-container"></div>
<div id="loading-overlay" class="hidden">
  <div class="spinner"></div>
  <span id="loading-msg">Saving...</span>
</div>

<!-- ===== JAVASCRIPT ===== -->
<script>
// =============================================================================
// i18n — TRANSLATIONS
// =============================================================================
var TRANSLATIONS = {
  en: {
    appTitle: 'RSA Driver App',
    brand: 'RSA Transport',
    homeSubtitle: 'Shift Management System',
    card1Title: 'Arrived at Warehouse',
    card1Sub: 'Stage 1 — Register your shift & odometer',
    card2Title: 'Leaving Warehouse',
    card2Sub: 'Stage 2 — Record your departure time',
    card3Title: 'Last Drop',
    card3Sub: 'Stage 3 — Record last drop & odometer photo',
    card4Title: 'Shift Complete',
    card4Sub: 'Stage 4 — Odometer reading & shift close',
    dashLink: 'View Operations Dashboard',
    timezone: 'Time zone: Asia/Dubai (UTC+4)',
    s1Header: 'Start of Shift',
    s2Header: 'Start of Shift — Departure',
    eos3Header: 'Last Drop — Stage 3',
    eos4Header: 'Shift Complete — Stage 4',
    step1: 'At Warehouse', step2: 'Departure',
    driverDetails: 'Driver Details',
    searchDriver: 'Driver', searchDriverPh: 'Search by name or employee ID',
    helperDetails: 'Helper Details',
    fromList: 'From List', manualEntry: 'Manual Entry',
    searchHelper: 'Search Helper', searchHelperPh: 'Type name or employee ID',
    supplierCompany: 'Supplier Company', supplierCompanyPh: 'Select supplier company',
    helperNameOptional: 'Helper Name (optional)', helperNamePh: 'Enter helper name if known',
    vehicleOdo: 'Vehicle & Odometer',
    vehicleNum: 'Vehicle Number', vehiclePh: 'Type to search vehicle',
    startOdo: 'Start Odometer (km)', startOdoPh: 'e.g. 123456',
    odoPhoto: 'Odometer Photo', cameraNote: 'Camera only — file upload not allowed',
    fuelTaken: 'Fuel Taken (Litres)', fuelPh: 'e.g. 40',
    shiftStartSection: 'Shift Start Time',
    arrivalLabel: 'Arrival at Gate Date & Time',
    routeInfo: 'Route & Drop Info',
    destinationEmirate: 'Destination Emirate', destinationEmiratePh: '-- Select Emirate --',
    primaryCustomer: 'Primary Customer Name', primaryCustomerPh: 'Search customer name',
    totalDrops: 'Total Drops', totalDropsPh: 'e.g. 25',
    saveContinue: 'Save & Continue to Stage 2',
    s1Saved: 'Stage 1 saved! Complete this step when leaving the warehouse.',
    confirmIdentity: 'Confirm Your Identity',
    searchYourName: 'Search Your Name',
    stage1Note: 'Only drivers who completed Stage 1 today are shown.',
    driverLabel: 'Driver', helperLabel: 'Helper', vehicleLabel: 'Vehicle', arrivedAt: 'Arrived at',
    departureLabel: 'Departure Date & Time',
    recordDeparture: 'Confirm Departure',
    selectDriver: 'Select Driver',
    eosDriverNote: 'All drivers with an active shift are shown (including those who skipped Stage 2).',
    eos4DriverNote: 'Drivers who completed Stage 3 are shown here.',
    refreshList: 'Refresh list',
    dropDetails: 'Drop Details',
    lastDrop: 'Last Drop Date & Time',
    lastDropPhoto: 'Last Drop Odometer Photo',
    saveLastDrop: 'Save Last Drop',
    failedDrops: 'Number of Failed Drops',
    endOdoSection: 'End Odometer & Photo',
    endOdo: 'End Odometer (km)', endOdoPh: 'e.g. 124500',
    shiftCompleteSection: 'Shift Complete Time',
    shiftComplete: 'Shift Complete Date & Time',
    completeShift: 'Complete Shift',
    backHome: 'Back to Home',
    incompleteShiftError: 'You have an incomplete shift from {date}. Please complete {stage} before starting a new shift.',
    stuckStage2Label: 'Stage 2 (Departure)',
    stuckStage3Label: 'Stage 3 (Last Drop)',
    stuckStage4Label: 'Stage 4 (Shift Complete)'
  },
  hi: {
    appTitle: 'RSA ड्राइवर ऐप',
    brand: 'RSA ट्रांसपोर्ट',
    homeSubtitle: 'शिफ्ट प्रबंधन प्रणाली',
    card1Title: 'गोदाम पर पहुंचे',
    card1Sub: 'चरण 1 — शिफ्ट और ओडोमीटर दर्ज करें',
    card2Title: 'गोदाम छोड़ना',
    card2Sub: 'चरण 2 — प्रस्थान समय दर्ज करें',
    card3Title: 'अंतिम डिलीवरी',
    card3Sub: 'चरण 3 — अंतिम डिलीवरी और ओडोमीटर फोटो',
    card4Title: 'शिफ्ट पूर्ण',
    card4Sub: 'चरण 4 — ओडोमीटर पढ़ाई और शिफ्ट बंद',
    dashLink: 'ऑपरेशन डैशबोर्ड देखें',
    timezone: 'समय क्षेत्र: एशिया/दुबई (UTC+4)',
    s1Header: 'शिफ्ट शुरुआत',
    s2Header: 'शिफ्ट शुरुआत — प्रस्थान',
    eos3Header: 'अंतिम डिलीवरी — चरण 3',
    eos4Header: 'शिफ्ट पूर्ण — चरण 4',
    step1: 'गोदाम पर', step2: 'प्रस्थान',
    driverDetails: 'ड्राइवर विवरण',
    searchDriver: 'ड्राइवर', searchDriverPh: 'नाम या कर्मचारी ID खोजें',
    helperDetails: 'सहायक विवरण',
    fromList: 'सूची से', manualEntry: 'मैन्युअल दर्ज',
    searchHelper: 'सहायक खोजें', searchHelperPh: 'नाम या ID टाइप करें',
    supplierCompany: 'सप्लायर कंपनी', supplierCompanyPh: 'सप्लायर कंपनी चुनें',
    helperNameOptional: 'सहायक नाम (वैकल्पिक)', helperNamePh: 'सहायक का नाम दर्ज करें',
    vehicleOdo: 'वाहन और ओडोमीटर',
    vehicleNum: 'वाहन नंबर', vehiclePh: 'वाहन खोजें',
    startOdo: 'शुरुआती ओडोमीटर (km)', startOdoPh: 'उदा. 123456',
    odoPhoto: 'ओडोमीटर फोटो', cameraNote: 'केवल कैमरा — फ़ाइल अपलोड की अनुमति नहीं',
    fuelTaken: 'ईंधन लिया (लीटर)', fuelPh: 'उदा. 40',
    shiftStartSection: 'शिफ्ट शुरू समय',
    arrivalLabel: 'गेट पर पहुंचने की तारीख और समय',
    routeInfo: 'रूट और डिलीवरी जानकारी',
    destinationEmirate: 'गंतव्य अमीरात', destinationEmiratePh: '-- अमीरात चुनें --',
    primaryCustomer: 'मुख्य ग्राहक का नाम', primaryCustomerPh: 'ग्राहक खोजें',
    totalDrops: 'कुल डिलीवरी', totalDropsPh: 'उदा. 25',
    saveContinue: 'सहेजें और चरण 2 पर जाएं',
    s1Saved: 'चरण 1 सहेजा गया! गोदाम छोड़ते समय यह चरण पूरा करें।',
    confirmIdentity: 'अपनी पहचान सत्यापित करें',
    searchYourName: 'अपना नाम खोजें',
    stage1Note: 'केवल वे ड्राइवर दिखाए जाते हैं जिन्होंने आज चरण 1 पूरा किया।',
    driverLabel: 'ड्राइवर', helperLabel: 'सहायक', vehicleLabel: 'वाहन', arrivedAt: 'पहुंचे',
    departureLabel: 'प्रस्थान तारीख और समय',
    recordDeparture: 'प्रस्थान दर्ज करें',
    selectDriver: 'ड्राइवर चुनें',
    eosDriverNote: 'सक्रिय शिफ्ट वाले सभी ड्राइवर दिखाए जाते हैं।',
    eos4DriverNote: 'चरण 3 पूरा करने वाले ड्राइवर दिखाए जाते हैं।',
    refreshList: 'सूची रीफ्रेश करें',
    dropDetails: 'डिलीवरी विवरण',
    lastDrop: 'अंतिम डिलीवरी तारीख और समय',
    lastDropPhoto: 'अंतिम डिलीवरी ओडोमीटर फोटो',
    saveLastDrop: 'अंतिम डिलीवरी सहेजें',
    failedDrops: 'विफल डिलीवरी की संख्या',
    endOdoSection: 'अंतिम ओडोमीटर और फोटो',
    endOdo: 'अंतिम ओडोमीटर (km)', endOdoPh: 'उदा. 124500',
    shiftCompleteSection: 'शिफ्ट समाप्ति समय',
    shiftComplete: 'शिफ्ट समाप्ति तारीख और समय',
    completeShift: 'शिफ्ट पूरी करें',
    backHome: 'होम पर वापस जाएं',
    incompleteShiftError: '{date} की शिफ्ट अधूरी है। नई शिफ्ट शुरू करने से पहले {stage} पूरी करें।',
    stuckStage2Label: 'चरण 2 (प्रस्थान)',
    stuckStage3Label: 'चरण 3 (अंतिम डिलीवरी)',
    stuckStage4Label: 'चरण 4 (शिफ्ट पूर्ण)'
  },
  ar: {
    appTitle: 'تطبيق RSA للسائق',
    brand: 'RSA للنقل',
    homeSubtitle: 'نظام إدارة المناوبات',
    card1Title: 'وصل إلى المستودع',
    card1Sub: 'المرحلة 1 — سجل وردتك والعداد',
    card2Title: 'مغادرة المستودع',
    card2Sub: 'المرحلة 2 — سجل وقت المغادرة',
    card3Title: 'آخر توصيل',
    card3Sub: 'المرحلة 3 — سجل آخر توصيل وصورة العداد',
    card4Title: 'إنهاء الوردة',
    card4Sub: 'المرحلة 4 — قراءة العداد وإغلاق الوردة',
    dashLink: 'عرض لوحة العمليات',
    timezone: 'المنطقة الزمنية: آسيا/دبي (UTC+4)',
    s1Header: 'بداية الوردة',
    s2Header: 'بداية الوردة — المغادرة',
    eos3Header: 'آخر توصيل — المرحلة 3',
    eos4Header: 'إنهاء الوردة — المرحلة 4',
    step1: 'في المستودع', step2: 'المغادرة',
    driverDetails: 'تفاصيل السائق',
    searchDriver: 'السائق', searchDriverPh: 'ابحث بالاسم أو رقم الموظف',
    helperDetails: 'تفاصيل المساعد',
    fromList: 'من القائمة', manualEntry: 'إدخال يدوي',
    searchHelper: 'ابحث عن مساعد', searchHelperPh: 'اكتب الاسم أو رقم الهوية',
    supplierCompany: 'شركة المورد', supplierCompanyPh: 'اختر شركة المورد',
    helperNameOptional: 'اسم المساعد (اختياري)', helperNamePh: 'أدخل اسم المساعد إن عُرف',
    vehicleOdo: 'المركبة والعداد',
    vehicleNum: 'رقم المركبة', vehiclePh: 'ابحث عن المركبة',
    startOdo: 'عداد البداية (كم)', startOdoPh: 'مثال: 123456',
    odoPhoto: 'صورة العداد', cameraNote: 'الكاميرا فقط — رفع الملفات غير مسموح',
    fuelTaken: 'الوقود المأخوذ (لتر)', fuelPh: 'مثال: 40',
    shiftStartSection: 'وقت بدء الوردة',
    arrivalLabel: 'تاريخ ووقت الوصول إلى البوابة',
    routeInfo: 'معلومات المسار والتوصيل',
    destinationEmirate: 'الإمارة المقصودة', destinationEmiratePh: '-- اختر الإمارة --',
    primaryCustomer: 'اسم العميل الرئيسي', primaryCustomerPh: 'ابحث عن العميل',
    totalDrops: 'إجمالي التوصيلات', totalDropsPh: 'مثال: 25',
    saveContinue: 'حفظ والمتابعة للمرحلة 2',
    s1Saved: 'تم حفظ المرحلة 1! أكمل هذه الخطوة عند مغادرة المستودع.',
    confirmIdentity: 'تأكيد هويتك',
    searchYourName: 'ابحث عن اسمك',
    stage1Note: 'يُعرض السائقون الذين أكملوا المرحلة 1 اليوم فقط.',
    driverLabel: 'السائق', helperLabel: 'المساعد', vehicleLabel: 'المركبة', arrivedAt: 'وصل في',
    departureLabel: 'تاريخ ووقت المغادرة',
    recordDeparture: 'تسجيل المغادرة',
    selectDriver: 'اختر السائق',
    eosDriverNote: 'يُعرض جميع السائقين ذوي الوردات النشطة.',
    eos4DriverNote: 'يُعرض السائقون الذين أكملوا المرحلة 3.',
    refreshList: 'تحديث القائمة',
    dropDetails: 'تفاصيل التوصيل',
    lastDrop: 'تاريخ ووقت آخر توصيل',
    lastDropPhoto: 'صورة عداد آخر توصيل',
    saveLastDrop: 'حفظ آخر توصيل',
    failedDrops: 'عدد التوصيلات الفاشلة',
    endOdoSection: 'عداد النهاية والصورة',
    endOdo: 'عداد النهاية (كم)', endOdoPh: 'مثال: 124500',
    shiftCompleteSection: 'وقت إنهاء الوردة',
    shiftComplete: 'تاريخ ووقت اكتمال الوردة',
    completeShift: 'إنهاء الوردة',
    backHome: 'العودة إلى الرئيسية',
    incompleteShiftError: 'لديك وردة غير مكتملة بتاريخ {date}. يرجى إكمال {stage} قبل بدء وردة جديدة.',
    stuckStage2Label: 'المرحلة 2 (المغادرة)',
    stuckStage3Label: 'المرحلة 3 (آخر توصيل)',
    stuckStage4Label: 'المرحلة 4 (إنهاء الوردة)'
  },
  ur: {
    appTitle: 'ڈرائیور حاضری',
    brand: 'RSA ٹرانسپورٹ',
    homeSubtitle: 'شفٹ مینجمنٹ سسٹم',
    card1Title: 'گودام پر پہنچے',
    card1Sub: 'مرحلہ 1 — اپنی شفٹ اور اوڈومیٹر درج کریں',
    card2Title: 'گودام چھوڑنا',
    card2Sub: 'مرحلہ 2 — روانگی کا وقت درج کریں',
    card3Title: 'آخری ڈیلیوری',
    card3Sub: 'مرحلہ 3 — آخری ڈیلیوری اور اوڈومیٹر فوٹو',
    card4Title: 'شفٹ مکمل',
    card4Sub: 'مرحلہ 4 — اوڈومیٹر ریڈنگ اور شفٹ بند',
    dashLink: 'آپریشن ڈیش بورڈ دیکھیں',
    timezone: 'ٹائم زون: ایشیا/دبئی (UTC+4)',
    s1Header: 'شفٹ کا آغاز',
    s2Header: 'شفٹ کا آغاز — روانگی',
    eos3Header: 'آخری ڈیلیوری — مرحلہ 3',
    eos4Header: 'شفٹ مکمل — مرحلہ 4',
    step1: 'گودام میں', step2: 'روانگی',
    driverDetails: 'ڈرائیور کی تفصیل',
    searchDriver: 'ڈرائیور', searchDriverPh: 'نام یا ملازم ID سے تلاش کریں',
    helperDetails: 'مددگار کی تفصیل',
    fromList: 'فہرست سے', manualEntry: 'دستی اندراج',
    searchHelper: 'مددگار تلاش کریں', searchHelperPh: 'نام یا ID لکھیں',
    supplierCompany: 'سپلائر کمپنی', supplierCompanyPh: 'سپلائر کمپنی منتخب کریں',
    helperNameOptional: 'مددگار کا نام (اختیاری)', helperNamePh: 'مددگار کا نام درج کریں',
    vehicleOdo: 'گاڑی اور اوڈومیٹر',
    vehicleNum: 'گاڑی نمبر', vehiclePh: 'گاڑی تلاش کریں',
    startOdo: 'ابتدائی اوڈومیٹر (km)', startOdoPh: 'مثال: 123456',
    odoPhoto: 'اوڈومیٹر فوٹو', cameraNote: 'صرف کیمرہ — فائل اپلوڈ کی اجازت نہیں',
    fuelTaken: 'ایندھن لیا (لیٹر)', fuelPh: 'مثال: 40',
    shiftStartSection: 'شفٹ شروع ہونے کا وقت',
    arrivalLabel: 'گیٹ پر پہنچنے کی تاریخ اور وقت',
    routeInfo: 'روٹ اور ڈیلیوری معلومات',
    destinationEmirate: 'منزل کا امارت', destinationEmiratePh: '-- امارت منتخب کریں --',
    primaryCustomer: 'بنیادی گاہک کا نام', primaryCustomerPh: 'گاہک تلاش کریں',
    totalDrops: 'کل ڈیلیوریاں', totalDropsPh: 'مثال: 25',
    saveContinue: 'محفوظ کریں اور مرحلہ 2 پر جائیں',
    s1Saved: 'مرحلہ 1 محفوظ ہوگیا! گودام چھوڑتے وقت یہ مرحلہ مکمل کریں۔',
    confirmIdentity: 'اپنی شناخت کی تصدیق کریں',
    searchYourName: 'اپنا نام تلاش کریں',
    stage1Note: 'صرف وہ ڈرائیور دکھائے جاتے ہیں جنہوں نے آج مرحلہ 1 مکمل کیا۔',
    driverLabel: 'ڈرائیور', helperLabel: 'مددگار', vehicleLabel: 'گاڑی', arrivedAt: 'پہنچے',
    departureLabel: 'روانگی کی تاریخ اور وقت',
    recordDeparture: 'روانگی درج کریں',
    selectDriver: 'ڈرائیور منتخب کریں',
    eosDriverNote: 'تمام فعال شفٹ والے ڈرائیور دکھائے جاتے ہیں۔',
    eos4DriverNote: 'مرحلہ 3 مکمل کرنے والے ڈرائیور دکھائے جاتے ہیں۔',
    refreshList: 'فہرست تازہ کریں',
    dropDetails: 'ڈیلیوری کی تفصیل',
    lastDrop: 'آخری ڈیلیوری کی تاریخ اور وقت',
    lastDropPhoto: 'آخری ڈیلیوری اوڈومیٹر فوٹو',
    saveLastDrop: 'آخری ڈیلیوری محفوظ کریں',
    failedDrops: 'ناکام ڈیلیوری کی تعداد',
    endOdoSection: 'آخری اوڈومیٹر اور فوٹو',
    endOdo: 'آخری اوڈومیٹر (km)', endOdoPh: 'مثال: 124500',
    shiftCompleteSection: 'شفٹ ختم ہونے کا وقت',
    shiftComplete: 'شفٹ مکمل ہونے کی تاریخ اور وقت',
    completeShift: 'شفٹ مکمل کریں',
    backHome: 'ہوم پر واپس جائیں',
    incompleteShiftError: '{date} کی شفٹ نامکمل ہے۔ نئی شفٹ شروع کرنے سے پہلے {stage} مکمل کریں۔',
    stuckStage2Label: 'مرحلہ 2 (روانگی)',
    stuckStage3Label: 'مرحلہ 3 (آخری ڈیلیوری)',
    stuckStage4Label: 'مرحلہ 4 (شفٹ مکمل)'
  }
};

var currentLang = 'en';

function t(key) {
  return (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) ||
         (TRANSLATIONS['en'] && TRANSLATIONS['en'][key]) || key;
}

function setLanguage(lang) {
  currentLang = lang;
  document.documentElement.setAttribute('dir', (lang === 'ar' || lang === 'ur') ? 'rtl' : 'ltr');
  // Update active state on lang buttons
  var labels = { en: 'EN', hi: 'हिं', ar: 'عر', ur: 'اُر' };
  document.querySelectorAll('.lang-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.textContent.trim() === labels[lang]);
  });
  // Update all data-i18n text
  document.querySelectorAll('[data-i18n]').forEach(function(el) {
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  // Update all data-i18n-placeholder attributes
  document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
}

// =============================================================================
// STATE
// =============================================================================
var state = {
  drivers:        APP_DATA.drivers        || [],
  helpers:        APP_DATA.helpers        || [],
  vehicles:       APP_DATA.vehicles       || [],
  destinations:   APP_DATA.destinations   || [],
  customers:      APP_DATA.customers      || [],
  helperCompanies: APP_DATA.helperCompanies || [],
  activeDrivers: [],
  stage1Drivers: [],   // drivers who completed Stage 1 today
  stage3Drivers: [],   // drivers who completed Stage 3 (eligible for Stage 4)
  currentRowId:  null,
  selectedEos3Driver: null,
  selectedEos4Driver: null,
  capturedPhotos: { start: null, lastDrop: null, end: null },
  cameraStreams:  { start: null, lastDrop: null, end: null },
  helperMode: 'search'  // 'search' | 'manual'
};

// =============================================================================
// HELPER UTILITIES
// =============================================================================
function pad2(n) { return n < 10 ? '0' + n : String(n); }

// Read value from a custom dt-picker widget as 'YYYY-MM-DDTHH:MM'
function getDtVal(baseId) {
  var d = document.getElementById(baseId + '-d');
  var h = document.getElementById(baseId + '-h');
  var m = document.getElementById(baseId + '-m');
  if (!d || !h || !m || !d.value) return '';
  return d.value + 'T' + h.value + ':' + m.value;
}

// Write a 'YYYY-MM-DDTHH:MM' string into a custom dt-picker widget
function setDtVal(baseId, isoStr) {
  var d = document.getElementById(baseId + '-d');
  var h = document.getElementById(baseId + '-h');
  var m = document.getElementById(baseId + '-m');
  if (!d || !h || !m) return;
  if (!isoStr) { d.value = ''; h.value = '00'; m.value = '00'; return; }
  var parts = isoStr.split('T');
  d.value = parts[0] || '';
  if (parts[1]) {
    var tp = parts[1].split(':');
    h.value = tp[0] ? tp[0].substring(0, 2) : '00';
    m.value = tp[1] ? tp[1].substring(0, 2) : '00';
  }
}

// Returns current Dubai time as 'YYYY-MM-DDTHH:MM' for datetime-local inputs
function getDubaiNowLocalString() {
  var now = new Date();
  // Dubai is UTC+4 (240 minutes ahead). Compute Dubai local time via UTC offset trick.
  var dubaiMs = now.getTime() + (now.getTimezoneOffset() + 240) * 60000;
  var d = new Date(dubaiMs);
  return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate()) +
         'T' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());
}

// Toggle between helper search mode and manual entry mode
function toggleHelperMode(mode) {
  state.helperMode = mode;

  var searchBtn  = document.getElementById('helper-mode-search');
  var manualBtn  = document.getElementById('helper-mode-manual');
  var searchPanel = document.getElementById('helper-panel-search');
  var manualPanel = document.getElementById('helper-panel-manual');

  if (mode === 'search') {
    searchBtn.classList.add('active');
    manualBtn.classList.remove('active');
    searchPanel.classList.remove('hidden');
    manualPanel.classList.add('hidden');
    // Clear manual fields
    document.getElementById('sos1-helper-company-manual').value = '';
    document.getElementById('sos1-helper-name-manual').value = '';
  } else {
    manualBtn.classList.add('active');
    searchBtn.classList.remove('active');
    manualPanel.classList.remove('hidden');
    searchPanel.classList.add('hidden');
    // Clear search fields
    document.getElementById('sos1-helper-search').value = '';
    document.getElementById('sos1-helper-id').value = '';
    document.getElementById('sos1-helper-name').value = '';
    document.getElementById('sos1-helper-company').value = '';
    document.getElementById('sos1-helper-list').classList.add('hidden');
    // Populate supplier company dropdown if not already done
    var sel = document.getElementById('sos1-helper-company-manual');
    if (sel && sel.options.length <= 1) {
      (state.helperCompanies || []).forEach(function(co) {
        var opt = document.createElement('option');
        opt.value = co;
        opt.textContent = co;
        sel.appendChild(opt);
      });
    }
  }
}

// =============================================================================
// NAVIGATION
// =============================================================================
function navigate(screen) {
  var all = ['screen-home','screen-sos-stage1','screen-sos-stage2',
             'screen-eos-stage3','screen-eos-stage4','screen-success','dashboard-app'];
  all.forEach(function(id) { document.getElementById(id).classList.add('hidden'); });

  if (screen === 'home') {
    resetForms();
    document.getElementById('screen-home').classList.remove('hidden');
    stopAllCameras();
  } else if (screen === 'sos-stage1') {
    document.getElementById('screen-sos-stage1').classList.remove('hidden');
  } else if (screen === 'sos-stage2') {
    document.getElementById('screen-sos-stage2').classList.remove('hidden');
    stopCamera('start');
    // Reset Stage 2 fields so user starts fresh
    document.getElementById('sos2-driver-search').value = '';
    document.getElementById('sos2-confirm-details').classList.add('hidden');
    state.currentRowId = null;
    loadStage1PendingDrivers();
  } else if (screen === 'eos-stage3') {
    document.getElementById('screen-eos-stage3').classList.remove('hidden');
    document.getElementById('eos3-form').classList.add('hidden');
    state.selectedEos3Driver = null;
    document.getElementById('eos3-driver-search').value = '';
    stopCamera('end');
    loadActiveDrivers();
  } else if (screen === 'eos-stage4') {
    document.getElementById('screen-eos-stage4').classList.remove('hidden');
    document.getElementById('eos4-form').classList.add('hidden');
    state.selectedEos4Driver = null;
    document.getElementById('eos4-driver-search').value = '';
    stopCamera('lastDrop');
    loadStage3Drivers();
  } else if (screen === 'success') {
    document.getElementById('screen-success').classList.remove('hidden');
    stopAllCameras();
  } else if (screen === 'dashboard') {
    document.getElementById('driver-app').classList.add('hidden');
    document.getElementById('dashboard-app').classList.remove('hidden');
    loadDashboard();
  }

  // When leaving dashboard back to driver app screens, make driver-app visible again
  if (screen !== 'dashboard') {
    document.getElementById('driver-app').classList.remove('hidden');
  }
}

function openDashboard() {
  navigate('dashboard');
}

// =============================================================================
// AUTOCOMPLETE ENGINE
// =============================================================================
function doAutocomplete(inputEl, dataKey, onSelect) {
  var query   = inputEl.value.toLowerCase().trim();
  var listId  = inputEl.parentElement.querySelector('.autocomplete-list').id;
  var listEl  = document.getElementById(listId);

  if (query.length < 1) { listEl.classList.add('hidden'); return; }

  var data    = state[dataKey] || [];
  var results = [];

  if (dataKey === 'drivers' || dataKey === 'stage1Drivers') {
    results = data.filter(function(d) {
      return d.name.toLowerCase().includes(query) || d.id.toLowerCase().includes(query);
    });
  } else if (dataKey === 'helpers') {
    results = data.filter(function(h) {
      return h.name.toLowerCase().includes(query) || h.id.toLowerCase().includes(query);
    });
  } else if (dataKey === 'vehicles') {
    results = data.filter(function(v) {
      return v.number.toLowerCase().includes(query);
    });
  } else if (dataKey === 'activeDrivers' || dataKey === 'stage3Drivers') {
    results = data.filter(function(d) {
      return d.driverName.toLowerCase().includes(query) || d.driverId.toLowerCase().includes(query);
    });
  } else if (dataKey === 'customers') {
    results = data.filter(function(c) {
      return c.name.toLowerCase().includes(query);
    });
  }

  results = results.slice(0, 8);
  listEl.innerHTML = '';

  if (results.length === 0) {
    listEl.innerHTML = '<div class="ac-empty">No results found</div>';
    listEl.classList.remove('hidden');
    return;
  }

  results.forEach(function(item, idx) {
    var div = document.createElement('div');
    div.className = 'ac-item';
    div.setAttribute('data-idx', idx);
    div.innerHTML = buildAcLabel(dataKey, item);
    div.addEventListener('click', function() {
      onSelect(item);
      listEl.classList.add('hidden');
      inputEl.value = getAcInputValue(dataKey, item);
    });
    listEl.appendChild(div);
  });

  listEl.classList.remove('hidden');
}

function buildAcLabel(dataKey, item) {
  if (dataKey === 'drivers' || dataKey === 'stage1Drivers') {
    return '<strong>' + esc(item.name) + '</strong><div class="ac-sub">' + esc(item.id) + '</div>';
  }
  if (dataKey === 'helpers') {
    return '<strong>' + esc(item.name) + '</strong><div class="ac-sub">' + esc(item.id) + (item.company ? ' &bull; ' + esc(item.company) : '') + '</div>';
  }
  if (dataKey === 'vehicles') {
    return '<strong>' + esc(item.number) + '</strong>';
  }
  if (dataKey === 'activeDrivers' || dataKey === 'stage3Drivers') {
    return '<strong>' + esc(item.driverName) + '</strong><div class="ac-sub">' + esc(item.driverId) + ' &bull; ' + esc(item.vehicleNumber) + '</div>';
  }
  if (dataKey === 'customers') {
    return '<strong>' + esc(item.name) + '</strong>';
  }
  return '';
}

function getAcInputValue(dataKey, item) {
  if (dataKey === 'drivers' || dataKey === 'stage1Drivers') return item.name + ' (' + item.id + ')';
  if (dataKey === 'helpers')      return item.name + ' (' + item.id + ')';
  if (dataKey === 'vehicles')     return item.number;
  if (dataKey === 'activeDrivers' || dataKey === 'stage3Drivers') return item.driverName + ' (' + item.driverId + ')';
  if (dataKey === 'customers') return item.name;
  return '';
}

function acKeyNav(event, listId) {
  var listEl = document.getElementById(listId);
  if (listEl.classList.contains('hidden')) return;
  var items  = listEl.querySelectorAll('.ac-item');
  var focused = listEl.querySelector('.ac-item.focused');
  var idx     = focused ? parseInt(focused.getAttribute('data-idx')) : -1;

  if (event.key === 'ArrowDown') {
    event.preventDefault();
    idx = Math.min(idx + 1, items.length - 1);
  } else if (event.key === 'ArrowUp') {
    event.preventDefault();
    idx = Math.max(idx - 1, 0);
  } else if (event.key === 'Enter' && focused) {
    event.preventDefault();
    focused.click();
    return;
  } else if (event.key === 'Escape') {
    listEl.classList.add('hidden');
    return;
  } else { return; }

  items.forEach(function(el) { el.classList.remove('focused'); });
  if (items[idx]) {
    items[idx].classList.add('focused');
    items[idx].scrollIntoView({ block: 'nearest' });
  }
}

// Close all dropdowns on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.autocomplete-wrapper')) {
    document.querySelectorAll('.autocomplete-list').forEach(function(el) {
      el.classList.add('hidden');
    });
  }
});

// =============================================================================
// AUTOCOMPLETE CALLBACKS
// =============================================================================
function onDriverSelect(driver) {
  document.getElementById('sos1-driver-id').value   = driver.id;
  document.getElementById('sos1-driver-name').value = driver.name;
  state._selectedDriver = driver;

  // Show chip, hide search area
  document.getElementById('sos1-chip-name').textContent = driver.name;
  document.getElementById('sos1-chip-id').textContent   = driver.id;
  document.getElementById('sos1-driver-chip').classList.remove('hidden');
  document.getElementById('sos1-driver-search-area').classList.add('hidden');
  document.getElementById('sos1-driver-list').classList.add('hidden');
}

function clearDriverSelection() {
  document.getElementById('sos1-driver-id').value   = '';
  document.getElementById('sos1-driver-name').value = '';
  state._selectedDriver = null;

  document.getElementById('sos1-driver-chip').classList.add('hidden');
  document.getElementById('sos1-driver-search-area').classList.remove('hidden');
  document.getElementById('sos1-driver-search').value = '';
}

function onHelperSelect(helper) {
  document.getElementById('sos1-helper-id').value      = helper.id;
  document.getElementById('sos1-helper-name').value    = helper.name;
  document.getElementById('sos1-helper-company').value = helper.company || '';
  state._selectedHelper = helper;
}

function onVehicleSelect(vehicle) {
  document.getElementById('sos1-vehicle-number').value = vehicle.number;
  state._selectedVehicle = vehicle;
}

function onStage2DriverSelect(driver) {
  state.currentRowId = driver.rowId;
  document.getElementById('sos2-c-driver').textContent  = driver.name + ' (' + driver.id + ')';
  document.getElementById('sos2-c-helper').textContent  = (driver.helperName || '—') + (driver.helperCompany ? ' / ' + driver.helperCompany : '');
  document.getElementById('sos2-c-vehicle').textContent = driver.vehicleNumber || '—';
  document.getElementById('sos2-c-arrival').textContent = driver.arrivalTime || '—';
  document.getElementById('sos2-confirm-details').classList.remove('hidden');
}

function onCustomerSelect(customer) {
  document.getElementById('sos1-customer-name').value = customer.name;
}

function onEos3DriverSelect(driver) {
  state.selectedEos3Driver = driver;

  // Reset Stage 3 form fields
  setDtVal('eos3-last-drop', '');
  var fd = document.getElementById('eos3-failed-drops');
  if (fd) fd.value = '0';
  state.capturedPhotos.lastDrop = null;
  var resultEl = document.getElementById('photo-result-lastDrop');
  var wrapEl   = document.getElementById('camera-wrapper-lastDrop');
  if (resultEl) resultEl.classList.add('hidden');
  if (wrapEl)   wrapEl.classList.remove('hidden');

  document.getElementById('eos3-form').classList.remove('hidden');
}

function onEos4DriverSelect(driver) {
  state.selectedEos4Driver = driver;

  // Reset Stage 4 form fields
  var odo = document.getElementById('eos4-odometer');
  if (odo) odo.value = '';
  setDtVal('eos4-shift-complete', getDubaiNowLocalString());
  state.capturedPhotos.end = null;
  var resultEl = document.getElementById('photo-result-end');
  var wrapEl   = document.getElementById('camera-wrapper-end');
  if (resultEl) resultEl.classList.add('hidden');
  if (wrapEl)   wrapEl.classList.remove('hidden');

  document.getElementById('eos4-form').classList.remove('hidden');
}

// =============================================================================
// STAGE 1 & 2 PENDING DRIVERS (server call for cross-device support)
// =============================================================================
function loadStage1PendingDrivers() {
  var loadingEl = document.getElementById('sos2-loading-drivers');
  var searchEl  = document.getElementById('sos2-driver-search');
  if (loadingEl) loadingEl.classList.remove('hidden');
  if (searchEl)  { searchEl.disabled = true; searchEl.value = ''; }

  callServer('getStage1PendingDrivers', [],
    function(result) {
      state.stage1Drivers = (result || []).map(function(d) {
        return {
          rowId:         d.rowId,
          id:            d.driverId,
          name:          d.driverName,
          vehicleNumber: d.vehicleNumber,
          helperName:    d.helperName,
          helperCompany: d.helperCompany,
          arrivalTime:   d.arrivalTime
        };
      });
      if (loadingEl) loadingEl.classList.add('hidden');
      if (searchEl)  searchEl.disabled = false;
    },
    function(err) {
      console.warn('Could not load stage 1 drivers:', err);
      if (loadingEl) loadingEl.classList.add('hidden');
      if (searchEl)  searchEl.disabled = false;
      showToast('Could not load drivers. Tap Refresh to try again.', 'error');
    }
  );
}

function loadActiveDrivers() {
  var loadingEl = document.getElementById('eos3-loading-drivers');
  var searchEl  = document.getElementById('eos3-driver-search');
  if (loadingEl) loadingEl.classList.remove('hidden');
  if (searchEl)  { searchEl.disabled = true; searchEl.value = ''; }

  callServer('getActiveDriversForEndShift', [],
    function(result) {
      state.activeDrivers = result || [];
      if (loadingEl) loadingEl.classList.add('hidden');
      if (searchEl)  searchEl.disabled = false;
    },
    function(err) {
      if (loadingEl) loadingEl.classList.add('hidden');
      if (searchEl)  searchEl.disabled = false;
      showToast('Could not load active drivers: ' + err, 'error');
    }
  );
}

function loadStage3Drivers() {
  var loadingEl = document.getElementById('eos4-loading-drivers');
  var searchEl  = document.getElementById('eos4-driver-search');
  if (loadingEl) loadingEl.classList.remove('hidden');
  if (searchEl)  { searchEl.disabled = true; searchEl.value = ''; }

  callServer('getStage3PendingDrivers', [],
    function(result) {
      state.stage3Drivers = result || [];
      if (loadingEl) loadingEl.classList.add('hidden');
      if (searchEl)  searchEl.disabled = false;
    },
    function(err) {
      if (loadingEl) loadingEl.classList.add('hidden');
      if (searchEl)  searchEl.disabled = false;
      showToast('Could not load drivers: ' + err, 'error');
    }
  );
}

// =============================================================================
// CAMERA MODULE
// =============================================================================
function startCamera(slot) {
  // Stop any existing stream for this slot before requesting a new one
  stopCamera(slot);

  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showCameraError(slot, 'Camera not supported. Please use Chrome or Safari.');
    return;
  }

  var wrapId = 'camera-wrapper-' + slot;
  var vidId  = 'camera-video-' + slot;

  document.getElementById(wrapId).classList.remove('hidden');
  document.getElementById('photo-result-' + slot).classList.add('hidden');

  // Remove any existing error div so we start fresh
  var existingErr = document.getElementById('camera-error-' + slot);
  if (existingErr) existingErr.remove();

  var assignStream = function(stream) {
    var video = document.getElementById(vidId);
    if (!video) { stream.getTracks().forEach(function(t){t.stop();}); return; }
    video.srcObject = stream;
    state.cameraStreams[slot] = stream;
  };

  // First try: prefer rear camera
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } },
    audio: false
  }).then(assignStream).catch(function(err) {
    // Fallback: try any camera if facingMode caused the failure
    if (err.name === 'OverconstrainedError' || err.name === 'NotFoundError' || err.name === 'NotReadableError') {
      return navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(assignStream);
    }
    throw err;
  }).catch(function(err) {
    var msg;
    if (err.name === 'NotAllowedError') {
      msg = 'Camera blocked by browser. In Chrome, tap the lock icon (🔒) in the address bar → Site settings → Camera → Allow. Then tap Retry.';
    } else if (err.name === 'NotFoundError') {
      msg = 'No camera found on this device.';
    } else {
      msg = 'Could not access camera: ' + err.message;
    }
    showCameraError(slot, msg);
  });
}

function showCameraError(slot, msg) {
  var areaId = 'camera-area-' + slot;
  var areaEl = document.getElementById(areaId);
  var wrapEl = document.getElementById('camera-wrapper-' + slot);
  if (wrapEl) wrapEl.classList.add('hidden');

  // Remove old error if present
  var old = document.getElementById('camera-error-' + slot);
  if (old) old.remove();

  var errDiv = document.createElement('div');
  errDiv.className = 'camera-error';
  errDiv.id = 'camera-error-' + slot;
  errDiv.innerHTML = '<span class="material-icons">no_photography</span>'
    + '<span>' + esc(msg) + '</span>'
    + '<button class="btn btn-secondary" style="margin-top:10px;font-size:14px" type="button"'
    + ' onclick="retakePhoto(\'' + slot + '\')">'
    + '<span class="material-icons" style="font-size:16px">refresh</span> Retry Camera</button>';
  if (areaEl) {
    areaEl.appendChild(errDiv);
  }
}

function capturePhoto(slot) {
  var video  = document.getElementById('camera-video-' + slot);
  if (!video || !video.videoWidth) {
    showToast('Camera not ready. Please wait.', 'warning');
    return;
  }

  var canvas = document.createElement('canvas');
  var maxW   = 1280;
  var ratio  = Math.min(1, maxW / video.videoWidth);
  canvas.width  = Math.round(video.videoWidth  * ratio);
  canvas.height = Math.round(video.videoHeight * ratio);
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

  var dataUrl = canvas.toDataURL('image/jpeg', 0.75);
  state.capturedPhotos[slot] = dataUrl;

  document.getElementById('photo-img-' + slot).src = dataUrl;
  document.getElementById('photo-result-' + slot).classList.remove('hidden');
  document.getElementById('camera-wrapper-' + slot).classList.add('hidden');
}

function retakePhoto(slot) {
  state.capturedPhotos[slot] = null;
  document.getElementById('photo-result-' + slot).classList.add('hidden');
  document.getElementById('camera-wrapper-' + slot).classList.remove('hidden');
  var input = document.getElementById('camera-input-' + slot);
  if (input) input.value = '';
}

function onPhotoSelected(slot, input) {
  var file = input.files && input.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var img = new Image();
    img.onload = function() {
      var canvas = document.createElement('canvas');
      var MAX = 1280;
      var w = img.width, h = img.height;
      if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      var dataUrl = canvas.toDataURL('image/jpeg', 0.75);
      state.capturedPhotos[slot] = dataUrl;
      document.getElementById('photo-img-' + slot).src = dataUrl;
      document.getElementById('photo-result-' + slot).classList.remove('hidden');
      document.getElementById('camera-wrapper-' + slot).classList.add('hidden');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function stopCamera(slot) {
  if (state.cameraStreams[slot]) {
    state.cameraStreams[slot].getTracks().forEach(function(t) { t.stop(); });
    state.cameraStreams[slot] = null;
  }
}

function stopAllCameras() {
  stopCamera('start');
  stopCamera('lastDrop');
  stopCamera('end');
}

// =============================================================================
// FORM SUBMIT HANDLERS
// =============================================================================
function submitStage1() {
  var driverId      = val('sos1-driver-id');
  var driverName    = val('sos1-driver-name');
  var vehicleNum    = val('sos1-vehicle-number');
  var odometer      = val('sos1-odometer');
  var fuel          = val('sos1-fuel');
  var shiftStartTime = getDtVal('sos1-shift-start-time');
  var photo         = state.capturedPhotos.start;

  // Resolve helper fields based on mode
  var helperId   = '';
  var helperName = '';
  var helperCo   = '';
  var helperMode = state.helperMode || 'search';

  if (helperMode === 'search') {
    helperId   = val('sos1-helper-id');
    helperName = val('sos1-helper-name');
    helperCo   = val('sos1-helper-company');
    if (!helperId || !helperName) { showToast('Please select a helper from the list.', 'error'); return; }
  } else {
    helperCo   = val('sos1-helper-company-manual');
    helperName = val('sos1-helper-name-manual');  // optional
    if (!helperCo) { showToast('Please enter the supplier / company name for the helper.', 'error'); return; }
  }

  var destination = val('sos1-destination');
  var customer    = val('sos1-customer-name');
  var totalDrops  = val('sos1-total-drops');

  if (!driverId || !driverName) { showToast('Please select a driver.', 'error'); return; }
  if (!vehicleNum) { showToast('Please select a vehicle.', 'error'); return; }
  if (!odometer || Number(odometer) < 0) { showToast('Please enter a valid start odometer reading.', 'error'); return; }
  if (!photo) { showToast('Odometer photo is mandatory. Please take a photo.', 'error'); return; }
  if (!shiftStartTime) { showToast('Please enter the shift start date & time.', 'error'); return; }
  if (!destination) { showToast('Please select the destination emirate.', 'error'); return; }
  if (!customer) { showToast('Please select the primary customer name.', 'error'); return; }
  if (totalDrops === '' || Number(totalDrops) < 0) { showToast('Please enter total drops.', 'error'); return; }

  disableBtn('btn-sos1-submit');
  showLoading('Saving shift start...');

  callServer('saveShiftStart', [{
    driverId:           driverId,
    driverName:         driverName,
    helperId:           helperId,
    helperName:         helperName,
    helperCompany:      helperCo,
    vehicleNumber:      vehicleNum,
    startOdometer:      Number(odometer),
    startPhotoBase64:   photo,
    fuelTaken:          fuel,
    shiftStartTime:     shiftStartTime,
    destinationEmirate: destination,
    primaryCustomer:    customer,
    totalDrops:         Number(totalDrops)
  }],
  function(result) {
    hideLoading();
    enableBtn('btn-sos1-submit');
    if (result && result.success) {
      state.currentRowId = result.rowId;
      // Also push to stage1Drivers for immediate Stage 2 use
      state.stage1Drivers.push({
        rowId: result.rowId, id: driverId, name: driverName,
        vehicleNumber: vehicleNum, helperName: helperName,
        helperCompany: helperCo, arrivalTime: result.arrivalTime
      });
      navigate('sos-stage2');
    } else {
      var msg = (result && result.error) || 'Failed to save. Please try again.';
      // If server returned a structured incomplete-shift error, render in user's language
      if (result && result.incompleteShiftStageNum) {
        var stageKey = 'stuckStage' + result.incompleteShiftStageNum + 'Label';
        msg = t('incompleteShiftError')
          .replace('{date}', result.incompleteShiftDate || '')
          .replace('{stage}', t(stageKey));
      }
      showToast(msg, 'error');
    }
  },
  function(err) {
    hideLoading();
    enableBtn('btn-sos1-submit');
    showToast('Server error: ' + err, 'error');
  });
}

function submitStage2() {
  if (!state.currentRowId) { showToast('Please select your name first.', 'error'); return; }

  var departureTime = getDtVal('sos2-departure-time');
  if (!departureTime) { showToast('Please enter the departure date & time.', 'error'); return; }

  disableBtn('btn-sos2-submit');
  showLoading('Recording departure...');

  callServer('saveDeparture', [state.currentRowId, departureTime],
    function(result) {
      hideLoading();
      enableBtn('btn-sos2-submit');
      if (result && result.success) {
        state.currentRowId = null;
        showSuccess(
          'Stage 2 Complete!',
          'Departure recorded at ' + (result.departureTime || ''),
          null
        );
      } else {
        showToast((result && result.error) || 'Failed to save departure.', 'error');
      }
    },
    function(err) {
      hideLoading();
      enableBtn('btn-sos2-submit');
      showToast('Server error: ' + err, 'error');
    });
}

function submitStage3() {
  var driver      = state.selectedEos3Driver;
  var lastDrop    = getDtVal('eos3-last-drop');
  var failedDrops = val('eos3-failed-drops');
  var photo       = state.capturedPhotos.lastDrop;

  if (!driver) { showToast('Please select your name.', 'error'); return; }
  if (!lastDrop) { showToast('Please enter last drop date & time.', 'error'); return; }
  if (!photo) { showToast('Last drop odometer photo is mandatory. Please take a photo.', 'error'); return; }
  if (failedDrops === '' || Number(failedDrops) < 0) { showToast('Please enter number of failed drops.', 'error'); return; }

  disableBtn('btn-eos3-submit');
  showLoading('Saving last drop...');

  callServer('saveLastDrop', [{
    rowId:               driver.rowId,
    lastDropTime:        lastDrop,
    lastDropPhotoBase64: photo,
    failedDrops:         Number(failedDrops)
  }],
  function(result) {
    hideLoading();
    enableBtn('btn-eos3-submit');
    if (result && result.success) {
      stopCamera('lastDrop');
      state.capturedPhotos.lastDrop = null;
      state.selectedEos3Driver = null;
      showSuccess('Stage 3 Saved!', 'Last drop recorded. Please go to Stage 4 to complete your shift.', null);
    } else {
      showToast((result && result.error) || 'Failed to save last drop.', 'error');
    }
  },
  function(err) {
    hideLoading();
    enableBtn('btn-eos3-submit');
    showToast('Server error: ' + err, 'error');
  });
}

function submitStage4() {
  var driver          = state.selectedEos4Driver;
  var shiftCompleteTime = getDtVal('eos4-shift-complete');
  var odometer        = val('eos4-odometer');
  var photo           = state.capturedPhotos.end;

  if (!driver) { showToast('Please select your name.', 'error'); return; }
  if (!odometer || Number(odometer) < 0) { showToast('Please enter a valid end odometer reading.', 'error'); return; }
  if (!photo) { showToast('End odometer photo is mandatory.', 'error'); return; }
  if (!shiftCompleteTime) { showToast('Please enter shift complete date & time.', 'error'); return; }

  disableBtn('btn-eos4-submit');
  showLoading('Completing shift...');

  callServer('saveShiftEnd', [{
    rowId:             driver.rowId,
    shiftCompleteTime: shiftCompleteTime,
    endOdometer:       Number(odometer),
    endPhotoBase64:    photo
  }],
  function(result) {
    hideLoading();
    enableBtn('btn-eos4-submit');
    if (result && result.success) {
      var statsMsg = result.shiftDuration
        ? 'Shift Duration: ' + result.shiftDuration + ' hrs' +
          (result.overtime > 0 ? ' | Overtime: ' + result.overtime + ' hrs' : '')
        : '';
      showSuccess('Shift Complete!', 'Your shift has been recorded.', statsMsg);
      state.capturedPhotos.end = null;
      state.selectedEos4Driver = null;
    } else {
      showToast((result && result.error) || 'Failed to complete shift.', 'error');
    }
  },
  function(err) {
    hideLoading();
    enableBtn('btn-eos4-submit');
    showToast('Server error: ' + err, 'error');
  });
}

function showSuccess(title, msg, stats) {
  document.getElementById('success-title').textContent = title;
  document.getElementById('success-msg').textContent   = msg;
  var statsEl = document.getElementById('success-stats');
  if (stats) {
    statsEl.textContent = stats;
    statsEl.classList.remove('hidden');
  } else {
    statsEl.classList.add('hidden');
  }
  navigate('success');
}

// =============================================================================
// SERVER CALL WRAPPER
// =============================================================================
function callServer(fnName, args, onSuccess, onFailure) {
  var runner = google.script.run
    .withSuccessHandler(function(result) { onSuccess(result); })
    .withFailureHandler(function(err)    { onFailure(err.message || String(err)); });

  runner[fnName].apply(runner, args);
}

// =============================================================================
// DASHBOARD MODULE
// =============================================================================
var dashCharts = {};

function loadDashboard() {
  showLoading('Loading dashboard...');
  callServer('getDashboardData', [],
    function(data) {
      hideLoading();
      if (data && data.error) {
        showToast('Dashboard error: ' + data.error, 'error');
        return;
      }
      renderDashboard(data);
    },
    function(err) {
      hideLoading();
      showToast('Failed to load dashboard: ' + err, 'error');
    }
  );
}

function refreshDashboard() { loadDashboard(); }

function renderDashboard(data) {
  try {
  var now = new Date();
  document.getElementById('dash-updated').textContent = 'Updated ' + now.toLocaleTimeString();
  document.getElementById('dash-date-label').textContent =
    now.toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  var todayStats = data.todayStats || {};

  // Stat cards
  setText('stat-active',        data.activeCount || 0);
  setText('stat-completed',     todayStats.completedShiftsCount || 0);
  setText('stat-avg-duration',  Number(todayStats.avgShiftDuration || 0).toFixed(1));
  setText('stat-failed-drops',  todayStats.totalFailedDrops || 0);
  setText('stat-punchout',      (data.punchOutMisses || []).length);

  // Charts (guard against Chart.js CDN load failure)
  try { renderTrendChart(data.shiftTrendByDate || []); } catch(ce) { console.warn('Trend chart error:', ce); }

  // Active drivers, punch-out misses, failed drops, overtime
  renderActiveDriversWithStages(data.activeDrivers || []);
  renderPunchOutMisses(data.punchOutMisses || []);
  renderFailedDropsTable(data.failedDropsByDate || []);
  renderOvertimeTable(data.overtimeByDate || []);

  // Helper companies
  var topHelpers  = todayStats.topHelperCompanies || [];
  var companyList = document.getElementById('company-list');
  var maxCount    = topHelpers.length ? topHelpers[0].count : 1;
  if (!topHelpers.length) {
    companyList.innerHTML = '<div class="no-data"><span class="material-icons">business</span>No data for today</div>';
  } else {
    companyList.innerHTML = topHelpers.map(function(c) {
      var pct = Math.round((c.count / maxCount) * 100);
      return '<div class="company-item">' +
        '<span class="company-name">' + esc(c.company) + '</span>' +
        '<div class="company-bar-wrap"><div class="company-bar" style="width:' + pct + '%"></div></div>' +
        '<span class="company-count">' + c.count + '</span>' +
        '</div>';
    }).join('');
  }

  // Set default date pickers to yesterday and auto-load detail data
  var yesterday = getDubaiYesterdayString();
  var vdp  = document.getElementById('vehicle-date-picker');
  var stdp = document.getElementById('stage-timing-date-picker');
  if (vdp  && !vdp.value)  vdp.value  = yesterday;
  if (stdp && !stdp.value) stdp.value = yesterday;
  loadDetailData(yesterday);

  // Set default vehicle hours range: last 30 days
  var vhTo   = document.getElementById('vhours-to-picker');
  var vhFrom = document.getElementById('vhours-from-picker');
  if (vhTo && vhFrom && !vhTo.value) {
    var todayDubai = getDubaiTodayString();
    var thirtyAgo  = getDubaiNDaysAgoString(30);
    vhFrom.value = thirtyAgo;
    vhTo.value   = todayDubai;
    // Load vehicle hours for default range automatically
    loadVehicleHours();
  }

  } catch(renderErr) {
    console.error('Dashboard render error:', renderErr);
    showToast('Dashboard display error: ' + renderErr.message, 'error');
  }
}

function renderActiveDriversWithStages(activeDrivers) {
  var stageBadgeClass = { 1: 'badge-stage1', 2: 'badge-stage2', 3: 'badge-stage3' };
  var stageLabels     = { 1: 'Stage 1', 2: 'Stage 2', 3: 'Stage 3' };
  var activeBody = document.getElementById('tbody-active');
  document.getElementById('active-count-badge').textContent = activeDrivers.length;
  if (!activeDrivers.length) {
    activeBody.innerHTML = '<tr><td colspan="6" class="no-data"><span class="material-icons">person_off</span>No active drivers right now</td></tr>';
    return;
  }
  activeBody.innerHTML = activeDrivers.map(function(d) {
    var rowClass    = d.isOvertime ? 'class="overtime-row"' : '';
    var stageBadge  = '<span class="badge ' + (stageBadgeClass[d.currentStage] || '') + '">' + (stageLabels[d.currentStage] || '') + '</span>';
    var statusBadge = d.isOvertime
      ? '<span class="badge badge-overtime">OVERTIME</span>'
      : '<span class="badge badge-ok">On Duty</span>';
    var timeClass = 'running-time' + (d.isOvertime ? ' over' : '');
    return '<tr ' + rowClass + '>' +
      '<td>' + esc(d.driverName) + '</td>' +
      '<td>' + esc(d.vehicleNumber) + '</td>' +
      '<td>' + stageBadge + '</td>' +
      '<td>' + esc(d.arrivalTime) + '</td>' +
      '<td class="' + timeClass + '">' + d.runningHours.toFixed(1) + ' hrs</td>' +
      '<td>' + statusBadge + '</td>' +
      '</tr>';
  }).join('');
}

function renderPunchOutMisses(punchMisses) {
  var stageLabels = { 2: 'Stage 2 (Departure)', 3: 'Stage 3 (Last Drop)', 4: 'Stage 4 (Shift Complete)' };
  var missBody = document.getElementById('tbody-misses');
  document.getElementById('miss-count-badge').textContent = punchMisses.length;
  if (!punchMisses.length) {
    missBody.innerHTML = '<tr><td colspan="4" class="no-data"><span class="material-icons">check_circle</span>No punch-out misses</td></tr>';
    return;
  }
  missBody.innerHTML = punchMisses.map(function(m) {
    return '<tr>' +
      '<td>' + esc(m.shiftDate) + '</td>' +
      '<td>' + esc(m.driverName) + '</td>' +
      '<td>' + esc(m.vehicleNumber) + '</td>' +
      '<td><span class="badge badge-miss">' + esc(stageLabels[m.stuckStage] || 'Unknown') + '</span></td>' +
      '</tr>';
  }).join('');
}

function renderFailedDropsTable(failedDropsByDate) {
  var tbody = document.getElementById('tbody-failed-drops');
  if (!failedDropsByDate.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="no-data"><span class="material-icons">check_circle</span>No failed drops data</td></tr>';
    return;
  }
  var html = failedDropsByDate.map(function(row, idx) {
    var rateStyle  = row.failureRate > 20 ? 'color:var(--error);font-weight:700' : '';
    var drillClass = 'drill-' + idx;
    var driverRows = (row.drivers || []).map(function(d) {
      var dRate = d.totalDrops > 0 ? Math.round((d.failedDrops / d.totalDrops) * 1000) / 10 : 0;
      var dRateStyle = dRate > 20 ? 'color:var(--error);font-weight:700' : '';
      return '<tr class="drill-row ' + drillClass + '" style="display:none">' +
        '<td style="color:var(--text-secondary);padding-left:20px">↳ ' + esc(d.driverName) + '</td>' +
        '<td>' + d.totalDrops + '</td>' +
        '<td>' + d.failedDrops + '</td>' +
        '<td style="' + dRateStyle + '">' + dRate + '%</td>' +
        '<td></td>' +
        '</tr>';
    }).join('');
    return '<tr onclick="toggleDrill(\'' + drillClass + '\',this)" style="cursor:pointer">' +
      '<td>' + esc(row.date) + '</td>' +
      '<td>' + row.totalDrops + '</td>' +
      '<td>' + row.failedDrops + '</td>' +
      '<td style="' + rateStyle + '">' + row.failureRate + '%</td>' +
      '<td><span class="material-icons" style="font-size:16px;color:#999;vertical-align:middle">expand_more</span></td>' +
      '</tr>' + driverRows;
  }).join('');
  tbody.innerHTML = html;
}

function toggleDrill(drillClass, headerRow) {
  var rows   = document.querySelectorAll('tr.' + drillClass);
  var icon   = headerRow.querySelector('.material-icons');
  var hidden = rows.length && rows[0].style.display === 'none';
  rows.forEach(function(r) { r.style.display = hidden ? '' : 'none'; });
  if (icon) icon.textContent = hidden ? 'expand_less' : 'expand_more';
}

function renderOvertimeTable(overtimeByDate) {
  var tbody = document.getElementById('tbody-overtime');
  if (!overtimeByDate.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="no-data"><span class="material-icons">schedule</span>No overtime recorded</td></tr>';
    return;
  }
  var html = '';
  overtimeByDate.forEach(function(group) {
    group.drivers.forEach(function(d) {
      html += '<tr>' +
        '<td>' + esc(group.date) + '</td>' +
        '<td>' + esc(d.driverName) + '</td>' +
        '<td>' + d.shiftDuration.toFixed(1) + ' hrs</td>' +
        '<td style="color:var(--error);font-weight:700">' + d.overtime.toFixed(2) + ' hrs</td>' +
        '</tr>';
    });
  });
  tbody.innerHTML = html;
}

function renderTrendChart(trendData) {
  var ctx = document.getElementById('chart-trend').getContext('2d');
  if (dashCharts.trend) { dashCharts.trend.destroy(); }
  if (!trendData.length) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.fillStyle = '#999';
    ctx.font = '14px Roboto, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('No data yet', ctx.canvas.width / 2, ctx.canvas.height / 2);
    return;
  }
  dashCharts.trend = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: trendData.map(function(d) { return d.date; }),
      datasets: [
        {
          label: 'Avg Duration (hrs)',
          data: trendData.map(function(d) { return d.avgDuration; }),
          backgroundColor: 'rgba(21,101,192,0.8)',
          borderRadius: 4
        },
        {
          label: 'Total Overtime (hrs)',
          data: trendData.map(function(d) { return d.totalOvertime; }),
          backgroundColor: 'rgba(198,40,40,0.75)',
          borderRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        datalabels: {
          anchor: 'end', align: 'end',
          font: { size: 10 }, color: '#444',
          formatter: function(v) { return v > 0 ? v.toFixed(1) : ''; }
        }
      },
      scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } }
    }
  });
}

function renderVehicleChart(vehicleData) {
  var ctx = document.getElementById('chart-vehicles').getContext('2d');
  if (dashCharts.vehicles) { dashCharts.vehicles.destroy(); }
  if (!vehicleData.length) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.fillStyle = '#999';
    ctx.font = '14px Roboto, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('No data yet', ctx.canvas.width / 2, 80);
    return;
  }
  dashCharts.vehicles = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: vehicleData.map(function(v) { return v.vehicleNumber; }),
      datasets: [{
        label: 'Running Hours',
        data: vehicleData.map(function(v) { return v.totalHours; }),
        backgroundColor: 'rgba(25,118,210,0.8)',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end', align: 'end',
          font: { size: 11, weight: '600' }, color: '#1565C0',
          formatter: function(v) { return v > 0 ? v.toFixed(1) + ' h' : ''; }
        }
      },
      scales: { x: { beginAtZero: true, title: { display: true, text: 'Hours' } } }
    }
  });
}

function renderVehicleKmChart(vehicleKmByDate, dateStr) {
  var titleEl = document.getElementById('vehicle-km-title');
  if (titleEl) titleEl.textContent = 'Vehicle km Run — ' + (dateStr || '');
  var ctx = document.getElementById('chart-vehicle-km').getContext('2d');
  if (dashCharts.vehicleKm) { dashCharts.vehicleKm.destroy(); }
  if (!vehicleKmByDate.length) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.fillStyle = '#999';
    ctx.font = '14px Roboto, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('No data for selected date', ctx.canvas.width / 2, 80);
    return;
  }
  dashCharts.vehicleKm = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: vehicleKmByDate.map(function(v) { return v.vehicleNumber; }),
      datasets: [{
        label: 'km Run',
        data: vehicleKmByDate.map(function(v) { return v.km; }),
        backgroundColor: 'rgba(46,125,50,0.8)',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end', align: 'end',
          font: { size: 11, weight: '600' }, color: '#2E7D32',
          formatter: function(v) { return v > 0 ? v + ' km' : ''; }
        }
      },
      scales: { x: { beginAtZero: true, title: { display: true, text: 'km' } } }
    }
  });
}

function renderStageTimingTable(stageTimings, dateStr) {
  var titleEl = document.getElementById('stage-timing-title');
  if (titleEl) titleEl.textContent = 'Stage Timing — ' + (dateStr || '');
  var tbody = document.getElementById('tbody-stage-timing');
  if (!stageTimings.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="no-data"><span class="material-icons">timer_off</span>No shift data for this date</td></tr>';
    return;
  }
  tbody.innerHTML = stageTimings.map(function(row) {
    function fmtGap(gap, isAuto) {
      if (isAuto) return '<span style="color:#999">—</span>';
      if (gap === null || gap === undefined) return '<span style="color:#ccc">—</span>';
      var style = gap > 2 ? 'color:var(--error);font-weight:600' : '';
      return '<span style="' + style + '">' + gap.toFixed(2) + ' hrs</span>';
    }
    return '<tr>' +
      '<td>' + esc(row.driverName) + '</td>' +
      '<td>' + esc(row.vehicleNumber) + '</td>' +
      '<td>' + fmtGap(row.gap12, row.gap12Auto) + '</td>' +
      '<td>' + fmtGap(row.gap23, false) + '</td>' +
      '<td>' + fmtGap(row.gap34, false) + '</td>' +
      '</tr>';
  }).join('');
}

// Helper: get 'YYYY-MM-DD' for yesterday in Dubai time (UTC+4)
function getDubaiYesterdayString() {
  return getDubaiNDaysAgoString(1);
}

function getDubaiTodayString() {
  return getDubaiNDaysAgoString(0);
}

function getDubaiNDaysAgoString(n) {
  var now     = new Date();
  var dubaiMs = now.getTime() + (now.getTimezoneOffset() + 240) * 60000;
  var d       = new Date(dubaiMs - n * 86400000);
  var mm = String(d.getMonth() + 1).padStart(2, '0');
  var dd = String(d.getDate()).padStart(2, '0');
  return d.getFullYear() + '-' + mm + '-' + dd;
}

// Convert 'YYYY-MM-DD' to 'DD/MM/YYYY' for backend calls
function isoToDubai(isoStr) {
  if (!isoStr) return '';
  var p = isoStr.split('-');
  return p[2] + '/' + p[1] + '/' + p[0];
}

function loadDetailData(isoDateStr) {
  var dubaiDate = isoToDubai(isoDateStr);
  if (!dubaiDate) return;
  showLoading('Loading detail data...');
  callServer('getDashboardDetailData', [dubaiDate],
    function(data) {
      hideLoading();
      if (data && data.error) { showToast('Detail data error: ' + data.error, 'error'); return; }
      try { renderVehicleKmChart(data.vehicleKmByDate || [], isoDateStr); } catch(e) { console.warn('Vehicle km chart error:', e); }
      renderStageTimingTable(data.stageTimings || [], isoDateStr);
    },
    function(err) {
      hideLoading();
      showToast('Failed to load detail data: ' + err, 'error');
    }
  );
}

function loadVehicleKm() {
  var picker = document.getElementById('vehicle-date-picker');
  if (picker && picker.value) loadDetailData(picker.value);
}

function loadStageTimings() {
  var picker = document.getElementById('stage-timing-date-picker');
  if (picker && picker.value) loadDetailData(picker.value);
}

function loadVehicleHours() {
  var fromPicker = document.getElementById('vhours-from-picker');
  var toPicker   = document.getElementById('vhours-to-picker');
  if (!fromPicker || !toPicker || !fromPicker.value || !toPicker.value) {
    showToast('Please select both From and To dates.', 'error');
    return;
  }
  var fromDubai = isoToDubai(fromPicker.value);
  var toDubai   = isoToDubai(toPicker.value);
  var titleEl   = document.getElementById('vehicle-hours-title');
  if (titleEl) titleEl.textContent = 'Vehicle Running Hours (' + fromPicker.value + ' to ' + toPicker.value + ')';
  showLoading('Loading vehicle hours...');
  callServer('getVehicleHoursForRange', [fromDubai, toDubai],
    function(data) {
      hideLoading();
      if (data && data.error) { showToast('Vehicle hours error: ' + data.error, 'error'); return; }
      try { renderVehicleChart(data || []); } catch(e) { console.warn('Vehicle chart error:', e); }
    },
    function(err) {
      hideLoading();
      showToast('Failed to load vehicle hours: ' + err, 'error');
    }
  );
}

// Auto-refresh dashboard every 5 minutes
setInterval(function() {
  if (APP_VIEW === 'dashboard') { loadDashboard(); }
}, 5 * 60 * 1000);

// =============================================================================
// FORM RESET
// =============================================================================
function resetForms() {
  // Stage 1 fields
  var sos1Fields = ['sos1-driver-search','sos1-driver-id','sos1-driver-name',
                    'sos1-helper-search','sos1-helper-id','sos1-helper-name','sos1-helper-company',
                    'sos1-helper-company-manual','sos1-helper-name-manual',
                    'sos1-vehicle-search','sos1-vehicle-number','sos1-odometer','sos1-fuel',
                    'sos1-customer-search','sos1-customer-name','sos1-total-drops'];
  sos1Fields.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = '';
  });
  setDtVal('sos1-shift-start-time', '');
  var destEl = document.getElementById('sos1-destination');
  if (destEl) destEl.value = '';
  // Reset driver chip
  var chip = document.getElementById('sos1-driver-chip');
  var searchArea = document.getElementById('sos1-driver-search-area');
  if (chip) chip.classList.add('hidden');
  if (searchArea) searchArea.classList.remove('hidden');
  // Reset helper mode to search
  toggleHelperMode('search');

  // Stage 2 fields
  document.getElementById('sos2-driver-search').value = '';
  document.getElementById('sos2-confirm-details').classList.add('hidden');
  setDtVal('sos2-departure-time', '');

  // Stage 3 fields
  var eos3SearchEl = document.getElementById('eos3-driver-search');
  if (eos3SearchEl) eos3SearchEl.value = '';
  setDtVal('eos3-last-drop', '');
  var fd3 = document.getElementById('eos3-failed-drops');
  if (fd3) fd3.value = '0';
  var f3 = document.getElementById('eos3-form');
  if (f3) f3.classList.add('hidden');

  // Stage 4 fields
  ['eos4-driver-search','eos4-odometer'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = '';
  });
  setDtVal('eos4-shift-complete', '');
  var f4 = document.getElementById('eos4-form');
  if (f4) f4.classList.add('hidden');

  // Reset photo captures and camera previews
  ['start','lastDrop','end'].forEach(function(slot) {
    state.capturedPhotos[slot] = null;
    var resultEl  = document.getElementById('photo-result-' + slot);
    var wrapEl    = document.getElementById('camera-wrapper-' + slot);
    var errEl     = document.getElementById('camera-error-' + slot);
    var inputEl   = document.getElementById('camera-input-' + slot);
    if (resultEl) resultEl.classList.add('hidden');
    if (wrapEl)   wrapEl.classList.remove('hidden');
    if (errEl)    errEl.remove();
    if (inputEl)  inputEl.value = '';
  });

  // Reset state
  state._selectedDriver    = null;
  state._selectedHelper    = null;
  state._selectedVehicle   = null;
  state.selectedEos3Driver = null;
  state.selectedEos4Driver = null;
  state.currentRowId       = null;
  state.activeDrivers      = [];
  state.stage1Drivers      = [];
  state.stage3Drivers      = [];

  // Close any open autocomplete lists
  document.querySelectorAll('.autocomplete-list').forEach(function(el) {
    el.classList.add('hidden');
  });
}

// =============================================================================
// UTILITIES
// =============================================================================
var _toastTimer;
function showToast(msg, type) {
  var el = document.getElementById('toast-container');
  el.textContent = msg;
  el.className   = 'show ' + (type || '');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(function() { el.className = ''; }, 3500);
}

function showLoading(msg) {
  document.getElementById('loading-msg').textContent = msg || 'Loading...';
  document.getElementById('loading-overlay').classList.remove('hidden');
}

function hideLoading() {
  document.getElementById('loading-overlay').classList.add('hidden');
}

function disableBtn(id) {
  var el = document.getElementById(id);
  if (el) el.disabled = true;
}
function enableBtn(id) {
  var el = document.getElementById(id);
  if (el) el.disabled = false;
}

function val(id) {
  var el = document.getElementById(id);
  return el ? el.value.trim() : '';
}

function setText(id, text) {
  var el = document.getElementById(id);
  if (el) el.textContent = text;
}

function esc(str) {
  return String(str || '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// =============================================================================
// INIT
// =============================================================================
document.addEventListener('DOMContentLoaded', function() {
  if (APP_VIEW === 'dashboard') {
    document.getElementById('driver-app').classList.add('hidden');
    navigate('dashboard');
  } else {
    navigate('home');
  }

  if (APP_DATA && APP_DATA.error) {
    showToast('Warning: ' + APP_DATA.error, 'warning');
  }

  // Build hour (00-23) and minute (00-59) options for custom 24h datetime pickers
  ['sos1-shift-start-time','sos2-departure-time','eos3-last-drop','eos4-shift-complete'].forEach(function(baseId) {
    var hSel = document.getElementById(baseId + '-h');
    var mSel = document.getElementById(baseId + '-m');
    if (hSel) { for (var i = 0; i < 24; i++) { var o = document.createElement('option'); o.value = pad2(i); o.textContent = pad2(i); hSel.appendChild(o); } }
    if (mSel) { for (var j = 0; j < 60; j++) { var o = document.createElement('option'); o.value = pad2(j); o.textContent = pad2(j); mSel.appendChild(o); } }
  });

  // Populate destination emirate <select> from loaded data
  var destSelect = document.getElementById('sos1-destination');
  if (destSelect && state.destinations && state.destinations.length) {
    state.destinations.forEach(function(dest) {
      var opt = document.createElement('option');
      opt.value = dest;
      opt.textContent = dest;
      destSelect.appendChild(opt);
    });
  }

  // Fade out splash screen — show for at least 1.5 s so branding is visible
  setTimeout(function() {
    var splash = document.getElementById('splash-screen');
    if (!splash) return;
    splash.classList.add('fade-out');
    setTimeout(function() {
      if (splash.parentNode) splash.parentNode.removeChild(splash);
    }, 700);
  }, 1500);

  // Register service worker so Chrome on Android offers "Install App"
  // (standalone mode) instead of a browser shortcut.
  // The SW is served by our own doGet() at ?sw=1 — same origin as the page.
  if ('serviceWorker' in navigator && APP_DEPLOYMENT_URL) {
    navigator.serviceWorker.register(APP_DEPLOYMENT_URL + '?sw=1')
      .catch(function(err) {
        // SW registration failure is non-critical — app works fine without it.
        console.warn('Service Worker registration failed:', err);
      });
  }
});
</script>

</body>
</html>
